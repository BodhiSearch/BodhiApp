<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="OAuth2 authentication test app with PKCE support">
  <meta name="keywords" content="oauth, keycloak, authentication, test, pkce">
  <title>OAuth2 Authentication Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }

    input[type="text"],
    input[type="url"],
    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      box-sizing: border-box;
    }

    input[type="checkbox"] {
      margin-right: 8px;
    }

    .btn {
      background-color: #007bff;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    .btn:hover {
      background-color: #0056b3;
    }

    .btn-secondary {
      background-color: #6c757d;
    }

    .btn-secondary:hover {
      background-color: #545b62;
    }

    .hidden {
      display: none;
    }

    .success {
      background-color: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 4px;
      border: 1px solid #c3e6cb;
      margin: 20px 0;
    }

    .error {
      background-color: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 4px;
      border: 1px solid #f5c6cb;
      margin: 20px 0;
    }

    .token-display {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 300px;
      overflow-y: auto;
      margin: 10px 0;
    }

    .loading {
      text-align: center;
      padding: 20px;
      font-style: italic;
      color: #666;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>OAuth2 Authentication Test</h1>

    <div id="config-section">
      <h2>OAuth Configuration</h2>
      <form id="oauth-config">
        <div class="form-group">
          <label for="bodhi-server-url">BodhiApp Server URL:</label>
          <input type="url" id="bodhi-server-url" placeholder="http://localhost:1135" required />
        </div>

        <div class="form-group">
          <label for="auth-server-url">Authorization Server URL:</label>
          <input type="url" id="auth-server-url" placeholder="https://main-id.getbodhi.app" required />
        </div>

        <div class="form-group">
          <label for="realm">Realm:</label>
          <input type="text" id="realm" placeholder="bodhi" required />
        </div>

        <div class="form-group">
          <label for="client-id">Client ID:</label>
          <input type="text" id="client-id" placeholder="client-bodhi-dev-console" required />
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" id="confidential-client" />
            Confidential Client (requires client secret)
          </label>
        </div>

        <div class="form-group" id="client-secret-group">
          <label for="client-secret">Client Secret:</label>
          <input type="text" id="client-secret" placeholder="change-me" disabled />
        </div>

        <div class="form-group">
          <label for="redirect-uri">Redirect URI:</label>
          <input type="url" id="redirect-uri" placeholder="http://localhost/index.html" required />
        </div>

        <div class="form-group">
          <label for="scope">Scope:</label>
          <input type="text" id="scope" placeholder="openid profile email roles" />
        </div>

        <div class="form-group">
          <label for="requested-toolsets">Requested Toolsets (JSON array):</label>
          <textarea id="requested-toolsets" rows="3" placeholder='[{"toolset_type":"builtin-exa-search"}]'></textarea>
        </div>

        <button type="submit" class="btn" data-test-state="request-access">Request Access &amp; Login</button>
        <button type="button" class="btn btn-secondary" onclick="resetApp()">Reset</button>
      </form>
    </div>

    <div id="scope-status" class="hidden" style="background-color: #e8f5e9; border: 1px solid #a5d6a7; border-radius: 4px; padding: 15px; margin: 20px 0;">
      <div id="scope-status-message" data-test-resource-scope="" data-test-access-request-scope=""></div>
    </div>

    <div id="access-request-loading" class="hidden">
      <div class="loading">Requesting access...</div>
    </div>

    <div id="access-callback-loading" class="hidden">
      <div class="loading">Checking access request status...</div>
    </div>

    <div id="loading-section" class="hidden">
      <div class="loading">Exchanging authorization code for access token...</div>
    </div>

    <div id="error-section" class="hidden">
      <div class="error">
        <h3>Authentication Error</h3>
        <div id="error-message"></div>
      </div>
      <button class="btn" onclick="resetApp()">Try Again</button>
    </div>

    <div id="success-section" class="hidden">
      <div class="success">OAuth flow completed successfully!</div>
      <h3>Access Token:</h3>
      <div id="access-token" class="token-display"></div>
      <h3>Token Response:</h3>
      <div id="token-response" class="token-display"></div>
      <button class="btn" onclick="window.location.href='api.html'">Test API Calls</button>
      <button class="btn btn-secondary" onclick="resetApp()">Reset</button>
    </div>
  </div>

  <script>
    const ALL_SECTIONS = [
      'config-section',
      'access-request-loading',
      'access-callback-loading',
      'loading-section',
      'error-section',
      'success-section'
    ];

    function showSection(sectionId) {
      ALL_SECTIONS.forEach(function (id) {
        document.getElementById(id).classList.add('hidden');
      });
      document.getElementById(sectionId).classList.remove('hidden');
    }

    // Initialize app on page load
    window.addEventListener('load', function () {
      // Pre-fill form with default values
      document.getElementById('bodhi-server-url').value = 'http://localhost:1135';
      document.getElementById('auth-server-url').value = 'https://main-id.getbodhi.app';
      document.getElementById('realm').value = 'bodhi';
      document.getElementById('client-id').value = 'client-bodhi-dev-console';
      document.getElementById('client-secret').value = 'change-me';
      document.getElementById('redirect-uri').value = window.location.origin + window.location.pathname;
      document.getElementById('scope').value = 'openid profile email roles';

      // Handle confidential client checkbox
      document.getElementById('confidential-client').addEventListener('change', function () {
        document.getElementById('client-secret').disabled = !this.checked;
      });

      // Detect page load type by URL parameters
      var urlParams = new URLSearchParams(window.location.search);
      var code = urlParams.get('code');
      var state = urlParams.get('state');
      var id = urlParams.get('id');
      var error = urlParams.get('error');

      if (error || (code && state)) {
        // OAuth callback (success or error)
        handleOAuthCallback();
      } else if (id) {
        // Access request review callback
        handleAccessRequestCallback(id);
      }
      // Otherwise: fresh load, show config form (default)
    });

    // Handle form submission
    document.getElementById('oauth-config').addEventListener('submit', function (e) {
      e.preventDefault();
      var button = document.querySelector('button[type="submit"]');
      var state = button.getAttribute('data-test-state');
      if (state === 'login') {
        loginWithOAuth();
      } else {
        requestAccessAndLogin();
      }
    });

    async function requestAccessAndLogin() {
      var bodhiServerUrl = document.getElementById('bodhi-server-url').value.trim();
      var authServerUrl = document.getElementById('auth-server-url').value.trim();
      var realm = document.getElementById('realm').value.trim();
      var clientId = document.getElementById('client-id').value.trim();
      var isConfidential = document.getElementById('confidential-client').checked;
      var clientSecret = document.getElementById('client-secret').value.trim();
      var redirectUri = document.getElementById('redirect-uri').value.trim();
      var scope = document.getElementById('scope').value.trim();
      var requestedToolsetsRaw = document.getElementById('requested-toolsets').value.trim();

      if (!bodhiServerUrl || !authServerUrl || !realm || !clientId || !redirectUri) {
        showError('Please fill in all required fields');
        return;
      }

      // Parse requested toolsets if provided
      var requested = null;
      if (requestedToolsetsRaw) {
        try {
          var parsed = JSON.parse(requestedToolsetsRaw);
          requested = { toolset_types: parsed };
        } catch (e) {
          showError('Invalid JSON in Requested Toolsets: ' + e.message);
          return;
        }
      }

      // Store config in sessionStorage
      sessionStorage.setItem('oauthConfig', JSON.stringify({
        bodhiServerUrl: bodhiServerUrl,
        authServerUrl: authServerUrl,
        realm: realm,
        clientId: clientId,
        isConfidential: isConfidential,
        clientSecret: clientSecret,
        redirectUri: redirectUri,
        scope: scope,
        requestedToolsets: requestedToolsetsRaw
      }));

      showSection('access-request-loading');

      try {
        var body = {
          app_client_id: clientId,
          flow_type: 'redirect',
          redirect_url: window.location.origin + window.location.pathname
        };
        if (requested) {
          body.requested = requested;
        }

        var response = await fetch(bodhiServerUrl + '/bodhi/v1/apps/request-access', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        var data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || data.error || 'Request failed with status ' + response.status);
        }

        if (data.status === 'approved') {
          // Auto-approved: append resource_scope and show ready-to-login
          var updatedScope = scope;
          if (data.resource_scope) {
            updatedScope = scope + ' ' + data.resource_scope;
          }

          // Store approved scopes
          var config = JSON.parse(sessionStorage.getItem('oauthConfig'));
          config.approvedScopes = [data.resource_scope].filter(Boolean);
          config.accessRequestId = data.id;
          sessionStorage.setItem('oauthConfig', JSON.stringify(config));

          showReadyToLogin(updatedScope, data.resource_scope, null);
        } else if (data.status === 'draft') {
          // Needs user review: store id and redirect to review URL
          var config = JSON.parse(sessionStorage.getItem('oauthConfig'));
          config.accessRequestId = data.id;
          sessionStorage.setItem('oauthConfig', JSON.stringify(config));

          window.location.href = data.review_url;
        } else {
          throw new Error('Unexpected response status: ' + data.status);
        }
      } catch (err) {
        console.error('Access request error:', err);
        showError('Access request failed: ' + err.message);
      }
    }

    async function handleAccessRequestCallback(id) {
      showSection('access-callback-loading');

      var storedConfig = sessionStorage.getItem('oauthConfig');
      if (!storedConfig) {
        showError('OAuth configuration not found. Please start the flow again.');
        return;
      }

      var config = JSON.parse(storedConfig);

      try {
        var statusUrl = config.bodhiServerUrl + '/bodhi/v1/apps/access-requests/' + id
          + '?app_client_id=' + encodeURIComponent(config.clientId);

        var response = await fetch(statusUrl);
        var data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || data.error || 'Status check failed with status ' + response.status);
        }

        if (data.status === 'approved') {
          // Collect approved scopes
          var approvedScopes = [];
          if (data.resource_scope) approvedScopes.push(data.resource_scope);
          if (data.access_request_scope) approvedScopes.push(data.access_request_scope);

          var updatedScope = config.scope;
          if (approvedScopes.length > 0) {
            updatedScope = config.scope + ' ' + approvedScopes.join(' ');
          }

          // Update config
          config.approvedScopes = approvedScopes;
          config.accessRequestId = id;
          sessionStorage.setItem('oauthConfig', JSON.stringify(config));

          // Clear URL params before showing ready-to-login
          window.history.replaceState({}, document.title, window.location.pathname);

          showReadyToLogin(updatedScope, data.resource_scope, data.access_request_scope);
        } else if (data.status === 'denied') {
          showError('Access request was denied.');
        } else if (data.status === 'draft') {
          showError('Access request is still pending review.');
        } else {
          showError('Access request failed: ' + (data.message || 'Unknown status: ' + data.status));
        }
      } catch (err) {
        console.error('Access request status check error:', err);
        showError('Failed to check access request status: ' + err.message);
      }
    }

    function showReadyToLogin(resolvedScope, resourceScope, accessRequestScope) {
      // Update scope input with resolved scopes
      document.getElementById('scope').value = resolvedScope;

      // Update scope status display
      var statusEl = document.getElementById('scope-status-message');
      statusEl.setAttribute('data-test-resource-scope', resourceScope || '');
      statusEl.setAttribute('data-test-access-request-scope', accessRequestScope || '');
      statusEl.textContent = 'Scopes resolved: resource_scope: ' + (resourceScope || 'none')
        + ', access_request_scope: ' + (accessRequestScope || 'none');

      // Show scope status
      document.getElementById('scope-status').classList.remove('hidden');

      // Change button to Login state
      var button = document.querySelector('button[type="submit"]');
      button.textContent = 'Login';
      button.setAttribute('data-test-state', 'login');

      // Show config section (in case it was hidden)
      showSection('config-section');
    }

    function loginWithOAuth() {
      var scope = document.getElementById('scope').value.trim();
      startOAuthFlow(scope);
    }

    function startOAuthFlow(scopeOverride) {
      var storedConfig = sessionStorage.getItem('oauthConfig');
      if (!storedConfig) {
        showError('OAuth configuration not found. Please start the flow again.');
        return;
      }

      var config = JSON.parse(storedConfig);
      var authServerUrl = config.authServerUrl;
      var realm = config.realm;
      var clientId = config.clientId;
      var isConfidential = config.isConfidential;
      var redirectUri = config.redirectUri;
      var scope = scopeOverride || config.scope;

      // Generate PKCE parameters
      var codeVerifier = generateCodeVerifier();
      var oauthState = generateRandomString(32);

      generateCodeChallenge(codeVerifier).then(function (codeChallenge) {
        // Update config with PKCE params and final scope
        config.codeVerifier = codeVerifier;
        config.state = oauthState;
        config.scope = scope;
        sessionStorage.setItem('oauthConfig', JSON.stringify(config));

        // Build authorization URL
        var authUrl = new URL(authServerUrl + '/realms/' + realm + '/protocol/openid-connect/auth');
        authUrl.searchParams.append('client_id', clientId);
        authUrl.searchParams.append('redirect_uri', redirectUri);
        authUrl.searchParams.append('response_type', 'code');
        authUrl.searchParams.append('scope', scope);
        authUrl.searchParams.append('state', oauthState);

        // Add PKCE parameters for public clients
        if (!isConfidential) {
          authUrl.searchParams.append('code_challenge', codeChallenge);
          authUrl.searchParams.append('code_challenge_method', 'S256');
        }

        // Redirect to authorization server
        window.location.href = authUrl.toString();
      });
    }

    function handleOAuthCallback() {
      var urlParams = new URLSearchParams(window.location.search);
      var code = urlParams.get('code');
      var state = urlParams.get('state');
      var error = urlParams.get('error');

      if (error) {
        showError('OAuth Error: ' + error + ' - ' + (urlParams.get('error_description') || 'Unknown error'));
        return;
      }

      if (code && state) {
        var storedConfig = sessionStorage.getItem('oauthConfig');
        if (!storedConfig) {
          showError('OAuth configuration not found. Please try again.');
          return;
        }

        var config = JSON.parse(storedConfig);

        if (state !== config.state) {
          showError('Invalid state parameter. Possible CSRF attack.');
          return;
        }

        showSection('loading-section');
        exchangeCodeForToken(code, config);
      }
    }

    async function exchangeCodeForToken(code, config) {
      try {
        var tokenUrl = config.authServerUrl + '/realms/' + config.realm + '/protocol/openid-connect/token';

        var tokenParams = new URLSearchParams();
        tokenParams.append('grant_type', 'authorization_code');
        tokenParams.append('client_id', config.clientId);
        tokenParams.append('code', code);
        tokenParams.append('redirect_uri', config.redirectUri);

        // Add client secret for confidential clients
        if (config.isConfidential && config.clientSecret) {
          tokenParams.append('client_secret', config.clientSecret);
        }

        // Add PKCE code verifier for public clients
        if (!config.isConfidential) {
          tokenParams.append('code_verifier', config.codeVerifier);
        }

        var response = await fetch(tokenUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: tokenParams
        });

        var tokenData = await response.json();

        if (!response.ok) {
          throw new Error('Token exchange failed: ' + (tokenData.error_description || tokenData.error || 'Unknown error'));
        }

        // Show success
        showSection('success-section');

        // Display tokens
        document.getElementById('access-token').textContent = tokenData.access_token;
        document.getElementById('token-response').textContent = JSON.stringify(tokenData, null, 2);

        // Store access token for API testing
        sessionStorage.setItem('accessToken', tokenData.access_token);

        // Clear URL parameters
        window.history.replaceState({}, document.title, window.location.pathname);

      } catch (error) {
        console.error('Token exchange error:', error);
        showError('Token exchange failed: ' + error.message);
      }
    }

    function showError(message) {
      showSection('error-section');
      document.getElementById('error-message').textContent = message;
    }

    function resetApp() {
      // Clear session storage
      sessionStorage.clear();

      // Reset form
      document.getElementById('oauth-config').reset();

      // Show config section
      showSection('config-section');

      // Clear URL parameters
      window.history.replaceState({}, document.title, window.location.pathname);

      // Reset form values
      document.getElementById('bodhi-server-url').value = 'http://localhost:1135';
      document.getElementById('auth-server-url').value = 'https://main-id.getbodhi.app';
      document.getElementById('realm').value = 'bodhi';
      document.getElementById('client-id').value = 'client-bodhi-dev-console';
      document.getElementById('client-secret').value = 'change-me';
      document.getElementById('redirect-uri').value = window.location.origin + window.location.pathname;
      document.getElementById('scope').value = 'openid profile email roles';
      document.getElementById('requested-toolsets').value = '';
      document.getElementById('confidential-client').checked = false;
      document.getElementById('client-secret').disabled = true;

      // Reset button state
      var button = document.querySelector('button[type="submit"]');
      button.textContent = 'Request Access & Login';
      button.setAttribute('data-test-state', 'request-access');

      // Hide scope status
      document.getElementById('scope-status').classList.add('hidden');
      var statusEl = document.getElementById('scope-status-message');
      statusEl.setAttribute('data-test-resource-scope', '');
      statusEl.setAttribute('data-test-access-request-scope', '');
      statusEl.textContent = '';
    }

    // Utility functions for PKCE
    function generateRandomString(length) {
      var charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
      var result = '';
      for (var i = 0; i < length; i++) {
        result += charset.charAt(Math.floor(Math.random() * charset.length));
      }
      return result;
    }

    function generateCodeVerifier() {
      return generateRandomString(128);
    }

    async function generateCodeChallenge(verifier) {
      var encoder = new TextEncoder();
      var data = encoder.encode(verifier);
      var digest = await window.crypto.subtle.digest('SHA-256', data);
      return btoa(String.fromCharCode.apply(null, new Uint8Array(digest)))
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/, '');
    }
  </script>
</body>
</html>