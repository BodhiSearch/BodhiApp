# UI Chat Integration - Web Search Tool

> Layer: `crates/bodhi` (Next.js) | Status: â³ Pending | Phase: After 07-ui-pages (tool configuration)

## Overview

Integrate the Exa web search tool with the existing `/ui/chat` interface, enabling users to perform agentic web searches during conversations.

## Prerequisites

- Phase 7 (07-ui-pages): User must be able to configure the tool at `/ui/tools`
- Tool must be: app-enabled, user-enabled, and have API key configured

---

## User Stories

### US-1: Web Search Toggle Visibility

**As a user, I want to see a web search toggle in the chat interface that indicates whether web search is available.**

**Acceptance Criteria:**
- Toggle appears near the chat input area
- Toggle shows disabled state with tooltip when:
  - App-level disabled: "Web search is disabled for this app instance"
  - User not configured: "Configure web search in Tools settings"
  - User disabled: "Web search disabled by you"
- Toggle shows enabled state when tool is fully configured

### US-2: Web Search Activation

**As a user, I want to toggle web search on/off for my chat session.**

**Acceptance Criteria:**
- Click toggle to switch between on/off
- When enabled, tool definitions are included in chat API requests
- State persists in chat settings (localStorage)

### US-3: Tool Call Display

**As a user, I want to see tool calls and responses separately from AI replies.**

**Acceptance Criteria:**
- Tool calls displayed in collapsible UI (collapsed by default)
- Show tool name and status (calling/completed/error)
- Expandable to view full JSON request/response
- Visually distinct from assistant messages

### US-4: Agentic Loop Execution

**As a user, when the model requests web search, I want the tool to be executed and results fed back to the LLM.**

**Acceptance Criteria:**
- Detect `tool_calls` in streaming response
- Call `POST /bodhi/v1/tools/{tool_id}/execute` for each tool
- Send tool results back to `/v1/chat/completions` 
- Display final LLM response after tool execution

---

## Component Architecture

### Modified Files

| File | Changes |
|------|---------|
| `hooks/use-chat-settings.tsx` | Add `webSearch_enabled` setting |
| `hooks/use-chat.tsx` | Add tool call handling loop |
| `hooks/use-chat-completions.ts` | Handle `tool_calls` in response |
| `app/ui/chat/ChatUI.tsx` | Add web search toggle |
| `app/ui/chat/ChatMessage.tsx` | Add tool call display |
| `types/chat.ts` | Extend Message type for tools |

### New Files

| File | Purpose |
|------|---------|
| `app/ui/chat/WebSearchToggle.tsx` | Toggle component with status tooltip |
| `app/ui/chat/ToolCallMessage.tsx` | Collapsible tool call display |
| `hooks/use-tool-status.ts` | Hook to check tool availability |

---

## Implementation Details

### 1. Tool Availability Check

New hook to determine web search toggle state:

```typescript
// hooks/use-tool-status.ts
function useToolStatus(toolId: string) {
  const { data } = useQuery({
    queryKey: ['tool-status', toolId],
    queryFn: () => fetch(`/bodhi/v1/tools/${toolId}`).then(r => r.json()),
  });
  
  return {
    isAvailable: data?.app_enabled && data?.enabled && data?.has_api_key,
    disabledReason: !data?.app_enabled ? 'app_disabled' 
                  : !data?.has_api_key ? 'not_configured'
                  : !data?.enabled ? 'user_disabled' 
                  : null,
  };
}
```

### 2. Chat Settings Extension

Add web search to chat settings context:

```typescript
// In use-chat-settings.tsx - extend ChatSettings interface
interface ChatSettings {
  // ... existing settings
  webSearch_enabled: boolean;
}

// Add to defaultSettings
const defaultSettings: ChatSettings = {
  // ... existing
  webSearch_enabled: false,
};
```

### 3. Message Type Extension

Extend Message type to support tool calls:

```typescript
// types/chat.ts
export interface ToolCall {
  id: string;
  type: 'function';
  function: {
    name: string;
    arguments: string;
  };
}

export interface ToolResult {
  tool_call_id: string;
  content: string;
  error?: string;
}

export interface Message {
  // ... existing fields
  role: 'system' | 'user' | 'assistant' | 'tool';
  tool_calls?: ToolCall[];      // For assistant messages with tool calls
  tool_call_id?: string;        // For tool result messages
}
```

### 4. Agentic Loop in use-chat.tsx

Core loop handling tool calls:

```typescript
// Simplified flow in processCompletion
async function processCompletion(userMessages: Message[]) {
  const { webSearch_enabled, getRequestSettings } = chatSettings;
  
  // Build request with optional tool definitions
  const request = {
    ...getRequestSettings(),
    messages: requestMessages,
    ...(webSearch_enabled && {
      tools: [BUILTIN_EXA_TOOL_DEFINITION],
      tool_choice: 'auto',
    }),
  };

  await append({
    request,
    onToolCalls: async (toolCalls) => {
      // Execute each tool and collect results
      const results = await Promise.all(
        toolCalls.map(tc => executeToolCall(tc))
      );
      // Continue conversation with tool results
      return results;
    },
    onFinish: (message) => { /* save to DB */ },
  });
}

async function executeToolCall(toolCall: ToolCall): Promise<ToolResult> {
  const response = await fetch(`/bodhi/v1/tools/${toolCall.function.name}/execute`, {
    method: 'POST',
    body: JSON.stringify({
      tool_call_id: toolCall.id,
      arguments: JSON.parse(toolCall.function.arguments),
    }),
  });
  return response.json();
}
```

### 5. Chat Completion Response Handling

Update `use-chat-completions.ts` to detect tool calls:

```typescript
// In streaming response handler
if (json.choices?.[0]?.delta?.tool_calls) {
  // Accumulate tool calls
  onToolCallDelta?.(json.choices[0].delta.tool_calls);
}

if (json.choices?.[0]?.finish_reason === 'tool_calls') {
  // Response finished with tool calls - trigger execution
  onToolCalls?.(accumulatedToolCalls);
}
```

### 6. Web Search Toggle Component

```tsx
// app/ui/chat/WebSearchToggle.tsx
function WebSearchToggle() {
  const { webSearch_enabled, setWebSearchEnabled } = useChatSettings();
  const { isAvailable, disabledReason } = useToolStatus('builtin-exa-web-search');
  
  const tooltipText = {
    app_disabled: 'Web search is disabled for this app instance',
    not_configured: 'Configure web search in Tools settings',
    user_disabled: 'Web search disabled by you',
  }[disabledReason] || 'Enable web search';

  return (
    <Tooltip content={tooltipText}>
      <Switch
        checked={webSearch_enabled && isAvailable}
        onCheckedChange={setWebSearchEnabled}
        disabled={!isAvailable}
        data-testid="web-search-toggle"
      />
    </Tooltip>
  );
}
```

### 7. Tool Call Message Display

```tsx
// app/ui/chat/ToolCallMessage.tsx
function ToolCallMessage({ toolCall, result }: Props) {
  const [expanded, setExpanded] = useState(false);
  
  return (
    <Collapsible open={expanded} onOpenChange={setExpanded}>
      <CollapsibleTrigger className="tool-call-header">
        <Globe className="h-4 w-4" />
        <span>Web Search: {toolCall.function.name}</span>
        <Badge>{result ? 'Completed' : 'Calling...'}</Badge>
        <ChevronDown className={cn(expanded && 'rotate-180')} />
      </CollapsibleTrigger>
      <CollapsibleContent>
        <pre className="tool-call-json">
          {JSON.stringify({ request: toolCall, response: result }, null, 2)}
        </pre>
      </CollapsibleContent>
    </Collapsible>
  );
}
```

---

## API Interactions

### Chat Completion with Tools

**Request:**
```json
{
  "model": "llama3.2:3b",
  "messages": [{"role": "user", "content": "What's the latest news about AI?"}],
  "tools": [{
    "type": "function",
    "function": {
      "name": "builtin-exa-web-search",
      "description": "Search the web...",
      "parameters": {...}
    }
  }],
  "tool_choice": "auto",
  "stream": true
}
```

**Response (with tool call):**
```json
{
  "choices": [{
    "delta": {
      "tool_calls": [{
        "id": "call_123",
        "type": "function",
        "function": {
          "name": "builtin-exa-web-search",
          "arguments": "{\"query\": \"latest AI news 2026\"}"
        }
      }]
    },
    "finish_reason": "tool_calls"
  }]
}
```

### Tool Execution

**Request:** `POST /bodhi/v1/tools/builtin-exa-web-search/execute`
```json
{
  "tool_call_id": "call_123",
  "arguments": {"query": "latest AI news 2026", "num_results": 5}
}
```

**Response:**
```json
{
  "tool_call_id": "call_123",
  "result": {
    "results": [
      {"title": "...", "url": "...", "snippet": "..."}
    ]
  }
}
```

### Continue Conversation

**Request:** (send tool result back)
```json
{
  "model": "llama3.2:3b",
  "messages": [
    {"role": "user", "content": "What's the latest news about AI?"},
    {"role": "assistant", "tool_calls": [...]},
    {"role": "tool", "tool_call_id": "call_123", "content": "{...results...}"}
  ],
  "stream": true
}
```

---

## Data Test IDs

| Element | data-testid |
|---------|-------------|
| Web search toggle | `web-search-toggle` |
| Toggle tooltip | `web-search-tooltip` |
| Tool call message | `tool-call-message` |
| Tool call expand button | `tool-call-expand` |
| Tool call content | `tool-call-content` |

---

## E2E Test Cases

Add to `crates/lib_bodhiserver_napi/tests-js/specs/tools/`:

### chat-with-web-search.spec.mjs

| Test | Description |
|------|-------------|
| `test_web_search_toggle_disabled_when_not_configured` | Toggle disabled, shows tooltip |
| `test_web_search_toggle_enabled_when_configured` | Toggle clickable after tool setup |
| `test_chat_includes_tools_when_enabled` | Request includes tool definitions |
| `test_tool_call_execution_flow` | Full agentic loop with mocked LLM |
| `test_tool_call_display_collapsed` | Tool calls render collapsed |
| `test_tool_call_expand_shows_json` | Expand shows request/response |

---

## Dependencies

- Requires tool configuration UI (07-ui-pages.md) to be complete
- Requires backend tool APIs (Phases 1-7.6) already implemented
- LLM must support function calling (model-dependent)

---

## Related Documents

- [07-ui-pages.md](./07-ui-pages.md) - Tool configuration UI
- [04-routes-api.md](./04-routes-api.md) - Tool execution API
- [03-service-layer.md](./03-service-layer.md) - ToolService and tool definitions
