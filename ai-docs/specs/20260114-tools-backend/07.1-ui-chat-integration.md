# UI Chat Integration - Toolsets

> Layer: `crates/bodhi` (Next.js) | Status: ✅ Complete | Phase: After 07-ui-pages (toolset configuration)

## Overview

Integrate toolsets with the existing `/ui/chat` interface, enabling users to use configured toolsets during conversations via a toolsets dropdown/popover with individual tool selection.

## Prerequisites

- Phase 7 (07-ui-pages): User must be able to configure toolsets at `/ui/toolsets`
- Toolset must be: app-enabled, user-enabled, and have API key configured

---

## User Stories

### US-1: Toolsets Dropdown Visibility ✅

**As a user, I want to see a toolsets popover in the chat interface that shows available toolsets and their tools.**

**Acceptance Criteria:**
- Wrench icon button appears in chat input area (left side, after + button)
- Clicking opens popover showing all toolsets from `useAvailableToolsets()`
- Each toolset shows name and tool count in `(enabled/total)` format
- Badge on trigger button shows total enabled tool count across all toolsets
- Shows disabled state with tooltip when:
  - App-level disabled: "Disabled by administrator"
  - User not configured: "Configure in Toolsets settings"
  - User disabled: "Disabled in settings"
  - No API key: "API key not configured"

### US-2: Individual Tool Selection ✅

**As a user, I want to enable/disable individual tools within toolsets for my chat session.**

**Acceptance Criteria:**
- Expandable/collapsible row for each toolset (chevron icon)
- Tri-state parent checkbox for toolset (checked/unchecked/indeterminate)
- Individual checkbox for each tool within expanded toolset
- Clicking parent checkbox toggles all tools (enable all or disable all)
- Tool count badge shows `(enabledCount/totalTools)` format
- State stored as `Record<string, string[]>` mapping toolset_id to tool names
- State persists per-chat via `chat.enabledTools`
- New chats inherit selection from localStorage (`bodhi-last-toolset-selection`)

### US-3: Tool Call Display ✅

**As a user, I want to see tool calls and responses separately from AI replies.**

**Acceptance Criteria:**
- Tool calls displayed in collapsible UI component (collapsed by default)
- Shows parsed tool name (from `toolset__{id}__{name}` format) and toolset ID
- Status badge: "Calling..." (yellow), "Completed" (green), "Error" (red)
- Auto-expands during calling state with spinner
- Expanded view shows formatted JSON for arguments and result/error
- Visually distinct styling with border and muted background
- Tool result messages (`role: 'tool'`) nested under corresponding tool call

### US-4: Agentic Loop Execution ✅

**As a user, when the model requests a tool, I want the tool to be executed and results fed back to the LLM.**

**Acceptance Criteria:**
- Detect `tool_calls` in streaming response (accumulate chunks by index)
- Call `POST /bodhi/v1/toolsets/{toolset_id}/execute/{method}` for each tool
- Execute multiple tool calls in parallel via `Promise.allSettled`
- Continue execution even if some tools fail (send errors to LLM)
- Append tool results as `role: 'tool'` messages to conversation
- Continue agentic loop until `finish_reason: 'stop'` or max iterations
- Max iterations configurable in settings (default: 5)
- Inject warning system message at max iterations
- Full conversation persisted including tool calls and results
- AbortController support for cancelling in-flight requests

---

## Component Architecture

### Modified Files

| File | Changes |
|------|---------|
| `hooks/use-chat-settings.tsx` | Add `maxToolIterations` and `maxToolIterations_enabled` settings |
| `hooks/use-chat.tsx` | Multi-round agentic loop with parallel tool execution |
| `hooks/use-chat-completions.ts` | Accumulate `tool_calls` chunks, return `CompletionResult` with `finishReason` |
| `app/ui/chat/ChatUI.tsx` | Integrate `useToolsetSelection`, pass to `useChat` and `ToolsetsPopover` |
| `app/ui/chat/ChatMessage.tsx` | Render `ToolCallsDisplay` for messages with `tool_calls` |
| `app/ui/chat/settings/SettingsSidebar.tsx` | Add max tool iterations setting with switch and input |
| `types/chat.ts` | Extend `Message` with `tool_calls`, `tool_call_id`; `Chat` with `enabledTools` |

### New Files

| File | Purpose |
|------|---------|
| `app/ui/chat/ToolsetsPopover.tsx` | Expandable popover with nested toolset/tool checkboxes |
| `app/ui/chat/ToolCallMessage.tsx` | Collapsible tool call display with status badges |
| `hooks/use-toolset-selection.ts` | Manage per-chat tool selection with localStorage inheritance |
| `components/ui/collapsible.tsx` | Shadcn collapsible component |
| `components/ui/checkbox.tsx` | Shadcn checkbox component |

---

## Implementation Details

### 1. Tool Selection State (`use-toolset-selection.ts`)

```typescript
type EnabledTools = Record<string, string[]>;

export interface UseToolsetSelectionReturn {
  enabledTools: EnabledTools;
  toggleTool: (toolsetId: string, toolName: string) => void;
  toggleToolset: (toolsetId: string, allToolNames: string[]) => void;
  isToolsetEnabled: (toolsetId: string) => boolean;
  isToolEnabled: (toolsetId: string, toolName: string) => boolean;
  getToolsetCheckboxState: (toolsetId: string, totalTools: number) => CheckboxState;
  setEnabledTools: (tools: EnabledTools) => void;
  hasChanges: boolean;
}
```

- Initializes from `currentChat.enabledTools` or localStorage for new chats
- Saves to localStorage on every change for inheritance
- Returns tri-state checkbox state: `'checked' | 'unchecked' | 'indeterminate'`

### 2. Message Type Extension (`types/chat.ts`)

```typescript
export interface ToolCallFunction {
  name: string;
  arguments: string;
}

export interface ToolCall {
  id: string;
  type: 'function';
  function: ToolCallFunction;
}

export interface Message {
  role: 'system' | 'user' | 'assistant' | 'tool';
  content: string;
  tool_calls?: ToolCall[];      // For assistant messages
  tool_call_id?: string;        // For tool result messages
  metadata?: MessageMetadata;
}

export interface Chat {
  // ... existing fields
  enabledTools?: Record<string, string[]>;
}
```

### 3. Build Tools Array (`use-chat.tsx`)

```typescript
function buildToolsArray(
  enabledTools: Record<string, string[]>,
  availableToolsets: ToolsetWithTools[]
): ToolDefinition[] {
  const result: ToolDefinition[] = [];
  for (const toolset of availableToolsets) {
    const enabledToolNames = enabledTools[toolset.toolset_id] || [];
    for (const tool of toolset.tools) {
      if (enabledToolNames.includes(tool.function.name)) {
        result.push({
          type: 'function',
          function: {
            ...tool.function,
            name: `toolset__${toolset.toolset_id}__${tool.function.name}`,
          },
        });
      }
    }
  }
  return result;
}
```

### 4. Tool Execution (`use-chat.tsx`)

```typescript
async function executeToolCall(toolCall: ToolCall, signal: AbortSignal, headers: Record<string, string>): Promise<Message> {
  const toolsetId = parseToolsetId(toolCall.function.name);
  const method = parseToolName(toolCall.function.name);
  const url = `${baseUrl}/bodhi/v1/toolsets/${toolsetId}/execute/${method}`;

  const response = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...headers },
    body: JSON.stringify({
      tool_call_id: toolCall.id,
      params: JSON.parse(toolCall.function.arguments),
    }),
    signal,
  });

  const result: ToolsetExecutionResponse = await response.json();
  return {
    role: 'tool',
    content: result.error ? JSON.stringify({ error: result.error }) : JSON.stringify(result.result),
    tool_call_id: result.tool_call_id,
  };
}

// Parallel execution with error handling
async function executeToolCalls(toolCalls: ToolCall[], signal: AbortSignal, headers: Record<string, string>): Promise<Message[]> {
  const results = await Promise.allSettled(toolCalls.map((tc) => executeToolCall(tc, signal, headers)));
  // Continue even if some fail - return error messages for failed ones
}
```

### 5. Agentic Loop Flow

```
User sends message
       │
       ▼
Build tools array from enabledTools + availableToolsets
       │
       ▼
POST /v1/chat/completions (streaming, with tools[])
       │
       ▼
┌──────┴──────┐
│             │
▼             ▼
finish_reason  finish_reason
= 'stop'       = 'tool_calls'
│             │
│             ├─► Check iteration < maxIterations
│             │   (inject warning message at max)
│             │
│             ├─► Execute tool_calls in parallel
│             │   POST /bodhi/v1/toolsets/{id}/execute/{method}
│             │
│             ├─► Append assistant msg (with tool_calls)
│             │   Append tool result msgs (role: 'tool')
│             │
│             └─► Loop: make another completion request
│
▼
Save conversation to localStorage (includes tool calls)
```

---

## API Interactions

### Chat Completion with Tools

**Request:**
```json
{
  "model": "qwen3:1.7b",
  "messages": [{"role": "user", "content": "What's the latest news about AI?"}],
  "tools": [
    {
      "type": "function",
      "function": {
        "name": "toolset__builtin-exa-web-search__search",
        "description": "Search the web...",
        "parameters": {...}
      }
    }
  ],
  "stream": true
}
```

### Tool Execution

**Request:** `POST /bodhi/v1/toolsets/builtin-exa-web-search/execute/search`
```json
{
  "tool_call_id": "call_123",
  "params": {"query": "latest AI news 2026", "num_results": 5}
}
```

**Response:**
```json
{
  "tool_call_id": "call_123",
  "result": {
    "results": [
      {"title": "...", "url": "...", "text": "..."}
    ]
  }
}
```

---

## Data Test IDs

| Element | data-testid |
|---------|-------------|
| Toolsets popover trigger | `toolsets-popover-trigger` |
| Toolsets popover content | `toolsets-popover-content` |
| Toolsets badge | `toolsets-badge` |
| Toolset row | `toolset-row-{toolset_id}` |
| Toolset item container | `toolset-item-{toolset_id}` |
| Toolset expand button | `toolset-expand-{toolset_id}` |
| Toolset checkbox | `toolset-checkbox-{toolset_id}` |
| Tool row | `tool-row-{toolset_id}-{tool_name}` |
| Tool checkbox | `tool-checkbox-{toolset_id}-{tool_name}` |
| Tool call message | `tool-call-message` |
| Max iterations input | `max-tool-iterations-input` |

---

## E2E Test Files

### chat-toolsets.spec.mjs

| Test | Description |
|------|-------------|
| `toolsets popover trigger is visible` | Verifies wrench icon visible in chat input |
| `toolsets popover opens and shows toolsets list` | Popover displays toolsets heading |
| `toolsets popover displays Exa Web Search toolset` | Builtin toolset listed |
| `unconfigured toolset checkbox is disabled with tooltip` | Disabled state with reason tooltip |
| `max tool iterations setting is visible` | Settings sidebar has input |
| `can modify max tool iterations setting` | Input value changes persist |
| `toolset selection persists when popover is reopened` | State maintained across open/close |
| `toolsets badge shows count when tools enabled` | Badge shows total tool count (4) |

### chat-agentic.spec.mjs

| Test | Description |
|------|-------------|
| `agentic chat with Exa web search executes tool and generates response` | Full flow: configure toolset → enable in chat → send message → tool execution → final response |

---

## Key Design Decisions

1. **Per-tool selection**: Users can select individual tools within a toolset, not just entire toolsets
2. **Tri-state checkbox**: Parent toolset checkbox shows indeterminate state when some tools selected
3. **Tool count badge**: Shows total enabled tools across all toolsets (not toolset count)
4. **Parallel execution**: All tool calls executed via `Promise.allSettled`, errors don't stop others
5. **LocalStorage inheritance**: New chats inherit tool selection from previous chat
6. **No tool_choice parameter**: Uses default auto behavior (removed explicit `tool_choice: 'auto'`)
7. **Method in URL path**: Execute endpoint is `/execute/{method}` not `/execute` with method in body

---

## Related Documents

- [07-ui-pages.md](./07-ui-pages.md) - Toolset configuration UI
- [04-routes-api.md](./04-routes-api.md) - Toolset execution API
- [03-service-layer.md](./03-service-layer.md) - ToolsetService and tool definitions
