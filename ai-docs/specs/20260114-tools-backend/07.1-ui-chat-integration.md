# UI Chat Integration - Toolsets

> Layer: `crates/bodhi` (Next.js) | Status: â³ Pending | Phase: After 07-ui-pages (toolset configuration)

## Overview

Integrate toolsets with the existing `/ui/chat` interface, enabling users to use configured toolsets during conversations via a toolsets dropdown/popover.

## Prerequisites

- Phase 7 (07-ui-pages): User must be able to configure toolsets at `/ui/toolsets`
- Toolset must be: app-enabled, user-enabled, and have API key configured

---

## User Stories

### US-1: Toolsets Dropdown Visibility

**As a user, I want to see a toolsets popover in the chat interface that shows available toolsets and their tools.**

**Acceptance Criteria:**
- Icon button appears near the chat input area
- Clicking opens popover showing configured toolsets
- Each toolset shows name and count of tools
- Shows disabled state with tooltip when:
  - App-level disabled: "Toolset disabled for this app instance"
  - User not configured: "Configure toolset in Toolsets settings"
  - User disabled: "Toolset disabled by you"
- Shows enabled state when toolset is fully configured

### US-2: Toolset Selection

**As a user, I want to enable/disable toolsets for my chat session.**

**Acceptance Criteria:**
- Checkbox for each configured toolset
- When enabled, all tools from that toolset are included in chat API requests
- State persists in chat settings (localStorage)

### US-3: Tool Call Display

**As a user, I want to see tool calls and responses separately from AI replies.**

**Acceptance Criteria:**
- Tool calls displayed in collapsible UI (collapsed by default)
- Show tool name and status (calling/completed/error)
- Expandable to view full JSON request/response
- Visually distinct from assistant messages
- Tool name shows fully qualified format (e.g., `toolset__builtin-exa-web-search__search`)

### US-4: Agentic Loop Execution

**As a user, when the model requests a tool, I want the tool to be executed and results fed back to the LLM.**

**Acceptance Criteria:**
- Detect `tool_calls` in streaming response
- Call `POST /bodhi/v1/toolsets/{toolset_id}/execute` for each tool
- Send tool results back to `/v1/chat/completions` 
- Display final LLM response after tool execution

---

## Component Architecture

### Modified Files

| File | Changes |
|------|---------|
| `hooks/use-chat-settings.tsx` | Add `enabledToolsets: string[]` setting |
| `hooks/use-chat.tsx` | Add tool call handling loop |
| `hooks/use-chat-completions.ts` | Handle `tool_calls` in response |
| `app/ui/chat/ChatUI.tsx` | Add toolsets popover button |
| `app/ui/chat/ChatMessage.tsx` | Add tool call display |
| `types/chat.ts` | Extend Message type for tools |

### New Files

| File | Purpose |
|------|---------|
| `app/ui/chat/ToolsetsPopover.tsx` | Popover component with toolset checkboxes |
| `app/ui/chat/ToolCallMessage.tsx` | Collapsible tool call display |
| `hooks/use-toolset-status.ts` | Hook to check toolset availability |

---

## Implementation Details

### 1. Toolset Availability Check

```typescript
// hooks/use-toolset-status.ts
function useToolsetStatus(toolsetId: string) {
  const { data } = useQuery({
    queryKey: ['toolset-status', toolsetId],
    queryFn: () => fetch(`/bodhi/v1/toolsets/${toolsetId}`).then(r => r.json()),
  });
  
  return {
    isAvailable: data?.app_enabled && data?.enabled && data?.has_api_key,
    disabledReason: !data?.app_enabled ? 'app_disabled' 
                  : !data?.has_api_key ? 'not_configured'
                  : !data?.enabled ? 'user_disabled' 
                  : null,
    tools: data?.tools || [],
  };
}
```

### 2. Chat Settings Extension

```typescript
// In use-chat-settings.tsx - extend ChatSettings interface
interface ChatSettings {
  // ... existing settings
  enabledToolsets: string[];  // Array of enabled toolset IDs
}

const defaultSettings: ChatSettings = {
  // ... existing
  enabledToolsets: [],
};
```

### 3. Message Type Extension

```typescript
// types/chat.ts
export interface ToolCall {
  id: string;
  type: 'function';
  function: {
    name: string;  // e.g., "toolset__builtin-exa-web-search__search"
    arguments: string;
  };
}

export interface ToolResult {
  tool_call_id: string;
  content: string;
  error?: string;
}

export interface Message {
  // ... existing fields
  role: 'system' | 'user' | 'assistant' | 'tool';
  tool_calls?: ToolCall[];      // For assistant messages with tool calls
  tool_call_id?: string;        // For tool result messages
}
```

### 4. Agentic Loop

```typescript
// Simplified flow in processCompletion
async function processCompletion(userMessages: Message[]) {
  const { enabledToolsets, getRequestSettings } = chatSettings;
  
  // Get all tool definitions from enabled toolsets
  const toolDefinitions = enabledToolsets.flatMap(
    toolsetId => getToolsetTools(toolsetId)
  );
  
  const request = {
    ...getRequestSettings(),
    messages: requestMessages,
    ...(toolDefinitions.length > 0 && {
      tools: toolDefinitions,
      tool_choice: 'auto',
    }),
  };

  await append({
    request,
    onToolCalls: async (toolCalls) => {
      const results = await Promise.all(
        toolCalls.map(tc => executeToolCall(tc))
      );
      return results;
    },
    onFinish: (message) => { /* save to DB */ },
  });
}

async function executeToolCall(toolCall: ToolCall): Promise<ToolResult> {
  // Parse toolset_id from tool name: toolset__{toolset_id}__{tool_name}
  const toolsetId = parseToolsetId(toolCall.function.name);
  
  const response = await fetch(`/bodhi/v1/toolsets/${toolsetId}/execute`, {
    method: 'POST',
    body: JSON.stringify({
      tool_call_id: toolCall.id,
      tool_name: toolCall.function.name,
      arguments: JSON.parse(toolCall.function.arguments),
    }),
  });
  return response.json();
}
```

### 5. Toolsets Popover Component

```tsx
// app/ui/chat/ToolsetsPopover.tsx
function ToolsetsPopover() {
  const { enabledToolsets, setEnabledToolsets } = useChatSettings();
  const { data: toolsets } = useAvailableToolsets();
  
  return (
    <Popover>
      <PopoverTrigger asChild>
        <Button variant="ghost" size="icon">
          <Wrench className="h-4 w-4" />
        </Button>
      </PopoverTrigger>
      <PopoverContent>
        <div className="space-y-2">
          <h4 className="font-medium">Toolsets</h4>
          {toolsets?.toolsets.map(toolset => (
            <ToolsetCheckbox 
              key={toolset.toolset_id}
              toolset={toolset}
              checked={enabledToolsets.includes(toolset.toolset_id)}
              onCheckedChange={(checked) => {
                if (checked) {
                  setEnabledToolsets([...enabledToolsets, toolset.toolset_id]);
                } else {
                  setEnabledToolsets(enabledToolsets.filter(id => id !== toolset.toolset_id));
                }
              }}
            />
          ))}
        </div>
      </PopoverContent>
    </Popover>
  );
}

function ToolsetCheckbox({ toolset, checked, onCheckedChange }) {
  const { isAvailable, disabledReason } = useToolsetStatus(toolset.toolset_id);
  
  const tooltipText = {
    app_disabled: 'Toolset disabled for this app instance',
    not_configured: 'Configure in Toolsets settings',
    user_disabled: 'Toolset disabled by you',
  }[disabledReason] || '';

  return (
    <Tooltip content={tooltipText}>
      <div className="flex items-center gap-2">
        <Checkbox
          checked={checked && isAvailable}
          onCheckedChange={onCheckedChange}
          disabled={!isAvailable}
        />
        <div>
          <span className="font-medium">{toolset.name}</span>
          <span className="text-muted-foreground text-sm ml-2">
            ({toolset.tools.length} tools)
          </span>
        </div>
      </div>
    </Tooltip>
  );
}
```

### 6. Tool Call Message Display

```tsx
// app/ui/chat/ToolCallMessage.tsx
function ToolCallMessage({ toolCall, result }: Props) {
  const [expanded, setExpanded] = useState(false);
  
  // Parse tool name for display
  const displayName = toolCall.function.name.split('__').pop();
  
  return (
    <Collapsible open={expanded} onOpenChange={setExpanded}>
      <CollapsibleTrigger className="tool-call-header">
        <Wrench className="h-4 w-4" />
        <span>Tool: {displayName}</span>
        <Badge>{result ? 'Completed' : 'Calling...'}</Badge>
        <ChevronDown className={cn(expanded && 'rotate-180')} />
      </CollapsibleTrigger>
      <CollapsibleContent>
        <pre className="tool-call-json">
          {JSON.stringify({ request: toolCall, response: result }, null, 2)}
        </pre>
      </CollapsibleContent>
    </Collapsible>
  );
}
```

---

## API Interactions

### Chat Completion with Tools

**Request:**
```json
{
  "model": "llama3.2:3b",
  "messages": [{"role": "user", "content": "What's the latest news about AI?"}],
  "tools": [
    {
      "type": "function",
      "function": {
        "name": "toolset__builtin-exa-web-search__search",
        "description": "Search the web...",
        "parameters": {...}
      }
    },
    {
      "type": "function",
      "function": {
        "name": "toolset__builtin-exa-web-search__find_similar",
        ...
      }
    }
  ],
  "tool_choice": "auto",
  "stream": true
}
```

### Tool Execution

**Request:** `POST /bodhi/v1/toolsets/builtin-exa-web-search/execute`
```json
{
  "tool_call_id": "call_123",
  "tool_name": "toolset__builtin-exa-web-search__search",
  "arguments": {"query": "latest AI news 2026", "num_results": 5}
}
```

**Response:**
```json
{
  "tool_call_id": "call_123",
  "result": {
    "results": [
      {"title": "...", "url": "...", "snippet": "..."}
    ]
  }
}
```

---

## Data Test IDs

| Element | data-testid |
|---------|-------------|
| Toolsets popover trigger | `toolsets-popover-trigger` |
| Toolsets popover content | `toolsets-popover-content` |
| Toolset checkbox | `toolset-checkbox-{toolset_id}` |
| Tool call message | `tool-call-message` |
| Tool call expand button | `tool-call-expand` |
| Tool call content | `tool-call-content` |

---

## E2E Test Cases

### chat-with-toolsets.spec.mjs

| Test | Description |
|------|-------------|
| `test_toolsets_popover_shows_configured_toolsets` | Popover displays available toolsets |
| `test_toolset_checkbox_disabled_when_not_configured` | Checkbox disabled, shows tooltip |
| `test_toolset_checkbox_enabled_when_configured` | Checkbox clickable after setup |
| `test_chat_includes_tools_when_toolset_enabled` | Request includes tool definitions |
| `test_tool_call_execution_flow` | Full agentic loop with mocked LLM |
| `test_tool_call_display_collapsed` | Tool calls render collapsed |
| `test_tool_call_expand_shows_json` | Expand shows request/response |

---

## Dependencies

- Requires toolset configuration UI (07-ui-pages.md) to be complete
- Requires backend toolset APIs (Phases 1-7.6) already implemented
- LLM must support function calling (model-dependent)

---

## Related Documents

- [07-ui-pages.md](./07-ui-pages.md) - Toolset configuration UI
- [04-routes-api.md](./04-routes-api.md) - Toolset execution API
- [03-service-layer.md](./03-service-layer.md) - ToolsetService and tool definitions
