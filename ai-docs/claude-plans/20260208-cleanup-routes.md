# BodhiApp Structural Consolidation Plan

## Context

BodhiApp has accumulated structural debt from organic growth. Two error handling cleanups established uniform error patterns. This consolidation extends that work to route organization, service boundaries, naming consistency, and re-export hygiene.

**Goal**: Make code organization uniform, predictable, and aligned with natural domain boundaries.

**Delivery**: One PR with phased commits. Each commit independently compiles and passes tests.

---

## Phase 1: Route Reorganization (Priority #1)

### Target Structure for `crates/routes_app/src/`

```
crates/routes_app/src/
├── lib.rs                          # Organized re-exports with section comments
│
├── shared/                         # Cross-domain utilities
│   ├── mod.rs
│   ├── pagination.rs               # PaginationSortParams, defaults (from api_dto.rs)
│   ├── error.rs                    # LoginError (from error.rs)
│   ├── openapi.rs                  # BodhiOpenAPIDoc, endpoint constants (from openapi.rs)
│   ├── common.rs                   # RedirectResponse (from common.rs)
│   └── utils.rs                    # extract_request_host, is_valid_hostname (from utils.rs)
│
├── routes_auth/                    # OAuth flows
│   ├── mod.rs                      # re-exports
│   ├── login.rs                    # auth_initiate_handler, auth_callback_handler, logout_handler
│   ├── types.rs                    # AuthCallbackRequest, related DTOs
│   └── tests/
│       ├── mod.rs
│       └── login_test.rs
│
├── routes_users/                   # User management + user access requests
│   ├── mod.rs
│   ├── user_info.rs                # user_info_handler
│   ├── management.rs               # list_users_handler, change_user_role_handler, remove_user_handler
│   ├── access_request.rs           # user_request_access_handler, request_status_handler, list_pending/all, approve, reject
│   ├── types.rs                    # UserRouteError, AccessRequestError, DTOs
│   └── tests/
│       ├── mod.rs
│       ├── user_info_test.rs
│       ├── management_test.rs
│       └── access_request_test.rs
│
├── routes_models/                  # Local model management
│   ├── mod.rs
│   ├── aliases.rs                  # list_aliases_handler, get_user_alias_handler, create_alias_handler, update_alias_handler, list_local_modelfiles_handler
│   ├── pull.rs                     # list_downloads_handler, create_pull_request_handler, pull_by_alias_handler, get_download_status_handler
│   ├── metadata.rs                 # refresh_metadata_handler, queue_status_handler
│   ├── types.rs                    # CreateAliasError, ModelError, MetadataError, DTOs
│   └── tests/
│       ├── mod.rs
│       ├── aliases_test.rs
│       ├── pull_test.rs
│       └── metadata_test.rs
│
├── routes_api_models/              # External API provider models
│   ├── mod.rs
│   ├── api_models.rs               # 9 handlers (CRUD, test, fetch, sync, formats)
│   ├── types.rs                    # from api_models_dto.rs (CreateApiModelRequest, etc.)
│   └── tests/
│       ├── mod.rs
│       └── api_models_test.rs
│
├── routes_toolsets/                # Toolset management
│   ├── mod.rs
│   ├── toolsets.rs                 # 9 handlers + helpers (is_oauth_auth, extract_allowed_toolset_scopes)
│   ├── types.rs                    # from toolsets_dto.rs (CreateToolsetRequest, etc.)
│   └── tests/
│       ├── mod.rs
│       └── toolsets_test.rs
│
├── routes_app_request_access.rs    # Standalone: request_access_handler (app-to-app OAuth, from routes_login.rs)
├── routes_api_token.rs             # Standalone: create/update/list token handlers (tests split out)
├── routes_api_token_test.rs        # Tests extracted from routes_api_token.rs
├── routes_setup.rs                 # Standalone: app_info, setup, ping, health (tests split out)
├── routes_setup_test.rs            # Tests extracted from routes_setup.rs
├── routes_settings.rs              # Standalone: settings CRUD (tests split out)
├── routes_settings_test.rs         # Tests extracted from routes_settings.rs
├── routes_dev.rs                   # Standalone: dev utils (kept as-is)
│
├── api_dto.rs                      # Shared response DTOs (AliasResponse, PaginatedXxxResponse, etc.)
│                                   # Used by openapi.rs and multiple domains
│
└── test_utils/                     # Existing test utilities (unchanged)
```

### Naming Standards Applied
- All handler functions get consistent `_handler` suffix
- Domain-specific error enums stay co-located with their domain (in types.rs)
- Shared response DTOs (used by openapi.rs + multiple domains) stay in api_dto.rs

### Critical Implementation Detail: `__path_*` Re-export Chain
`openapi.rs` imports `__path_*` functions via `use crate::__path_foo_handler`. These are generated by `#[utoipa::path]` in each handler file. After moving handlers to subdirectories:
1. Each handler file exports `__path_*` functions automatically
2. Domain `mod.rs` does `pub use login::*;` (exports `__path_*`)
3. `lib.rs` does `pub use routes_auth::*;` (re-exports to `crate::`)
4. `openapi.rs` `use crate::__path_*` continues to resolve

This chain must be maintained in every phase.

---

## Commit Sequence

### Commit 1: Create `shared/` module ✅ DONE (298a21d7)

Moved cross-domain utilities into `shared/` sub-module. Created `shared/{mod,pagination,error,openapi,common,utils}.rs`. Deleted old `error.rs`, `common.rs`, `utils.rs`, `openapi.rs`. Updated `lib.rs` and `api_dto.rs`. Fixed `include_str!` path in shared/openapi.rs tests. All 217 tests pass.

### Commit 2: Create `routes_auth/` folder ✅ DONE (492b51a6)

Split `routes_login.rs` (1958 lines) into domain modules. Created `routes_auth/{mod,login,types}.rs` + `routes_auth/tests/{mod,login_test}.rs` (13 auth tests). Created standalone `routes_app_request_access.rs` (5 request_access tests). Deleted `routes_login.rs`. All 217 tests pass.

### Commit 3: Create `routes_users/` folder ✅ DONE (bf2d9bfa)

Consolidate user management from 3 source files into one domain folder.

**Source files → Target files:**

| Source | Lines | Tests | Target |
|---|---|---|---|
| `routes_user.rs` | 562 | 10 test fns (19 cases with parametrized) | `user_info.rs` + `tests/user_info_test.rs` |
| `routes_users_list.rs` | 500 | 5 test fns | `management.rs` + `tests/management_test.rs` |
| `routes_access_request.rs` | 639 | 4 test fns | `access_request.rs` + `tests/access_request_test.rs` |

**Types to extract to `routes_users/types.rs`:**

From `routes_user.rs`:
- `UserRouteError` enum (5 variants: InvalidHeader, EmptyToken, ListFailed, RoleChangeFailed, RemoveFailed)
- `TokenType` enum (Session, Bearer)
- `RoleSource` enum (Role, ScopeToken, ScopeUser)
- `TokenInfo` struct
- `UserResponse` enum (LoggedOut, LoggedIn, Token)

From `routes_users_list.rs`:
- `ListUsersParams` struct
- `ChangeRoleRequest` struct

From `routes_access_request.rs`:
- `AccessRequestError` enum (6 variants: AlreadyPending, AlreadyHasAccess, PendingRequestNotFound, RequestNotFound, InsufficientPrivileges, FetchFailed)
- `UserAccessStatusResponse` struct + `From<UserAccessRequest>` impl
- `ApproveUserAccessRequest` struct
- `PaginatedUserAccessResponse` struct

**Handlers (stay in their respective files, just moved):**

`user_info.rs`: `user_info_handler`
`management.rs`: `list_users_handler`, `change_user_role_handler`, `remove_user_handler`
`access_request.rs`: `user_request_access_handler`, `request_status_handler`, `list_pending_requests_handler`, `list_all_requests_handler`, `approve_request_handler`, `reject_request_handler`

**Create:**
- `routes_users/mod.rs` — re-exports all sub-modules
- `routes_users/types.rs` — all types/errors listed above
- `routes_users/user_info.rs` — handler only (types imported from `types.rs`)
- `routes_users/management.rs` — handlers only (types imported from `types.rs`)
- `routes_users/access_request.rs` — handlers only (types imported from `types.rs`)
- `routes_users/tests/mod.rs`
- `routes_users/tests/user_info_test.rs` — 10 test fns (19 parametrized cases)
- `routes_users/tests/management_test.rs` — 5 test fns
- `routes_users/tests/access_request_test.rs` — 4 test fns

**Delete:** `routes_user.rs`, `routes_users_list.rs`, `routes_access_request.rs`

**Modify:** `lib.rs` — replace 3 mod/use lines with `mod routes_users; pub use routes_users::*;`

**Import changes needed:**
- `routes_users_list.rs` uses `super::*` in tests → change to explicit `crate::` imports
- `routes_access_request.rs` uses `super::*` in tests → change to explicit `crate::` imports
- Handler files import types via `crate::{UserRouteError, AccessRequestError, ...}` (works through re-export chain)

**Verify:** `cargo check -p routes_app && cargo check -p routes_all && cargo test -p routes_app`

### Commit 4: Create `routes_models/` folder ✅ DONE

Consolidate local model management from 4 files.

**Create:**
- `routes_models/mod.rs`
- `routes_models/aliases.rs` — from `routes_models.rs` + `routes_create.rs`
- `routes_models/pull.rs` — from `routes_pull.rs`
- `routes_models/metadata.rs` — from `routes_models_metadata.rs`
- `routes_models/types.rs` — `CreateAliasError`, `ModelError`, `MetadataError`, domain DTOs
- `routes_models/tests/mod.rs`
- `routes_models/tests/aliases_test.rs`
- `routes_models/tests/pull_test.rs`
- `routes_models/tests/metadata_test.rs`

**Delete:** `routes_models.rs`, `routes_create.rs`, `routes_pull.rs`, `routes_models_metadata.rs`

**Modify:** `lib.rs` — replace 4 mod lines with `mod routes_models;`

**Verify:** `cargo check -p routes_app && cargo test -p routes_app`

### Commit 5: Create `routes_api_models/` folder ✅ DONE (ed65feb4)

Move API provider model handlers.

**Create:**
- `routes_api_models/mod.rs`
- `routes_api_models/api_models.rs` — 9 handlers from `routes_api_models.rs`
- `routes_api_models/types.rs` — from `api_models_dto.rs`
- `routes_api_models/tests/mod.rs`
- `routes_api_models/tests/api_models_test.rs`

**Delete:** `routes_api_models.rs`, `api_models_dto.rs`

**Modify:** `lib.rs` — replace 2 mod lines with `mod routes_api_models;`

**Verify:** `cargo check -p routes_app && cargo test -p routes_app`

### Commit 6: Create `routes_toolsets/` folder ✅ DONE (4f142c7b)

Move toolset management handlers.

**Create:**
- `routes_toolsets/mod.rs`
- `routes_toolsets/toolsets.rs` — 9 handlers + helpers from `routes_toolsets.rs`
- `routes_toolsets/types.rs` — from `toolsets_dto.rs`
- `routes_toolsets/tests/mod.rs`
- `routes_toolsets/tests/toolsets_test.rs`

**Delete:** `routes_toolsets.rs`, `toolsets_dto.rs`

**Modify:** `lib.rs` — replace 2 mod lines with `mod routes_toolsets;`

**Verify:** `cargo check -p routes_app && cargo test -p routes_app`

### Commit 7: Split tests from standalone route files ✅ DONE (8d77f77d)

Extract inline `#[cfg(test)]` modules from standalone files.

**Create:**
- `routes_api_token_test.rs`
- `routes_setup_test.rs`
- `routes_settings_test.rs`

**Modify:** `routes_api_token.rs`, `routes_setup.rs`, `routes_settings.rs` — remove inline test modules

**Modify:** `lib.rs` — add `#[cfg(test)] mod routes_api_token_test;` etc.

**Verify:** `cargo test -p routes_app`

### Commit 8: Organize `lib.rs` with section comments ✅ DONE (4f3a25bc)

Clean up the final `lib.rs` with logical grouping:

```rust
// -- Test utilities
#[cfg(feature = "test-utils")]
pub mod test_utils;
#[cfg(all(not(feature = "test-utils"), test))]
pub mod test_utils;

// -- Shared infrastructure
mod shared;

// -- Shared response DTOs
mod api_dto;

// -- Domain route modules (folders)
mod routes_auth;
mod routes_users;
mod routes_models;
mod routes_api_models;
mod routes_toolsets;

// -- Standalone route files
mod routes_app_request_access;
mod routes_api_token;
mod routes_setup;
mod routes_settings;
mod routes_dev;

// -- Test modules
#[cfg(test)] mod routes_api_token_test;
#[cfg(test)] mod routes_setup_test;
#[cfg(test)] mod routes_settings_test;

// -- Re-exports
pub use shared::*;
pub use api_dto::*;
pub use routes_auth::*;
pub use routes_users::*;
pub use routes_models::*;
pub use routes_api_models::*;
pub use routes_toolsets::*;
pub use routes_app_request_access::*;
pub use routes_api_token::*;
pub use routes_setup::*;
pub use routes_settings::*;
pub use routes_dev::*;
```

**Verify:** `cargo check -p routes_app && cargo test -p routes_app`

### Commit 9: Organize `objs` and `services` `lib.rs` re-exports ✅ DONE (be923037)

Add section comments to `objs/src/lib.rs` and `services/src/lib.rs`, grouping re-exports by domain. No code moves — just adding organizational comments.

**Verify:** `cargo check`

### Commit 10: Full test suite verification ✅ DONE

Run full backend test suite to catch any cross-crate issues.

**Verify:** `make test.backend`

---

## Phase 2: DbService Repository Split (Future PR)

### Target Structure for `crates/services/src/db/`

Split the 42-method `DbService` trait into 6 domain-specific repository traits:

| Repository | Methods | Source |
|---|---|---|
| `UserRepository` | user CRUD | DbService user methods |
| `ApiTokenRepository` | token CRUD | DbService token methods |
| `AccessRepository` | access request workflow | DbService access methods |
| `ModelRepository` | aliases, downloads, metadata, api_models | DbService model methods |
| `ToolsetRepository` | toolsets + configs | DbService toolset methods |
| `SettingsRepository` | settings | DbService settings methods |

All live in `crates/services/src/db/` sub-modules sharing the same SQLite pool. `DbService` becomes a thin facade or individual repositories are exposed via `AppService`.

**Note**: This is a separate PR because it affects the `services` crate and all consumers (every route crate, tests, mocks). The `mockall::automock` pattern needs updating — each repository trait gets its own mock.

---

## Files Summary

### Route Reorg (Commits 1-8)
- **Files created**: ~35 new files (domain folders + tests)
- **Files deleted**: ~14 old flat files
- **Files modified**: `lib.rs` (every commit), `api_dto.rs` (commit 1)
- **Crates affected**: `routes_app` only (re-exports keep `routes_all` working)

### Verification Strategy
Each commit follows this sequence before committing:
1. `cargo check -p routes_app` — fast compilation check
2. `cargo check -p routes_all` — consumer crate validation
3. `cargo test -p routes_app` — all unit tests pass, same test count (217)
4. **Sub-agent review** — launch a sub-agent to `git diff` the local changes and verify:
   - Every test function from deleted files exists in the new test files (by name and logic)
   - Every type/struct/enum from deleted files exists in the new types.rs
   - Every handler function from deleted files exists in the new handler files
   - No `use super::*` in new test files (explicit `crate::` imports only)
   - Module wiring in mod.rs and lib.rs is correct
5. Commit only after sub-agent confirms zero discrepancies
6. `make test.backend` as final commit (full integration)

### Key Risk: OpenAPI `__path_*` Functions
The `openapi.rs` (moved to `shared/openapi.rs`) imports ~50 `__path_*` functions via `use crate::*`. These must remain accessible through the re-export chain. Each commit must verify this by ensuring `cargo check -p routes_app` passes — any broken `__path_*` import causes a compile error immediately.
