# Refactor: Unified AuthContext Enum with Axum Extensions

## Context

The current auth middleware injects 7 separate `X-BodhiApp-*` headers into requests (Token, Role, Scope, UserId, Username, Azp, AccessRequestId). Route handlers consume these via 8 individual extractors (ExtractToken, ExtractUserId, ExtractUsername, ExtractRole, ExtractScope, MaybeToken, MaybeRole, MaybeAccessRequestId). This creates:
- Different headers injected depending on auth type (session vs API token vs OAuth)
- No single type representing "who is making this request"
- Fragile string-based header transport between middleware and handlers
- Handler signatures cluttered with multiple extractors

This refactoring introduces a single `AuthContext` enum with variant-specific fields, transported via Axum's typed `Extension<AuthContext>` mechanism.

## Design Decisions (from user interview)

| Decision | Choice |
|----------|--------|
| Transport mechanism | Axum `Extension<AuthContext>` (not headers) |
| AuthContext shape | Enum with variant-specific fields |
| AppRole | Keep unchanged (Session/ApiToken/ExchangedToken) |
| Middleware consolidation | Keep 2 middleware functions (tech debt) |
| api_auth_middleware signature | Keep current (ResourceRole, Option<TokenScope>, Option<UserScope>) |
| Route policy | Keep current approach (tech debt) |
| Toolset middleware | Consume AuthContext only, defer full refactor (tech debt) |
| Extractor style | Raw `Extension<AuthContext>` |
| remove_app_headers | Keep for defense-in-depth |

## AuthContext Enum Design

```rust
// In crates/auth_middleware/src/auth_context.rs

#[derive(Debug, Clone)]
pub enum AuthContext {
  Anonymous,
  Session {
    user_id: String,
    username: String,
    role: ResourceRole,
    token: String,
  },
  ApiToken {
    user_id: String,
    scope: TokenScope,
    token: String,
  },
  ExternalApp {
    user_id: String,
    scope: UserScope,
    token: String,
    azp: String,
    access_request_id: Option<String>,
  },
}
```

Convenience methods:
- `fn user_id(&self) -> Option<&str>` - None for Anonymous
- `fn token(&self) -> Option<&str>` - None for Anonymous
- `fn app_role(&self) -> Option<AppRole>` - maps to existing AppRole enum
- `fn is_authenticated(&self) -> bool` - true for non-Anonymous

Test factory methods (behind `test-utils` feature):
- `fn test_session(user_id, username, role) -> Self`
- `fn test_session_with_token(user_id, username, role, token) -> Self`
- `fn test_api_token(user_id, scope) -> Self`
- `fn test_external_app(user_id, scope, azp, access_request_id) -> Self`

Test extension helper (behind `test-utils` feature):
```rust
pub trait RequestAuthContextExt {
  fn with_auth_context(self, ctx: AuthContext) -> Self;
}

impl RequestAuthContextExt for Request<Body> {
  fn with_auth_context(mut self, ctx: AuthContext) -> Self {
    self.extensions_mut().insert(ctx);
    self
  }
}
```

---

## Phased Implementation

Crate dependency order: objs → services → server_core → auth_middleware → routes_app → server_app → lib_bodhiserver → lib_bodhiserver_napi → bodhi/src-tauri

### Phase 1: objs — No changes needed

AuthContext does not belong in objs. The existing `AppRole`, `ResourceRole`, `TokenScope`, `UserScope` types remain unchanged. AuthContext is first used in auth_middleware (Phase 4), which is the first crate that creates and consumes it.

#### Phase 1 Gate
```
cargo check -p objs && cargo test -p objs
```

---

### Phase 2: services — No changes needed

Services don't interact with HTTP auth headers or extractors. No changes required.

#### Phase 2 Gate
```
cargo check -p services && cargo test -p services
```

---

### Phase 3: server_core — Remove misplaced RequestAuthExt

**File**: `crates/server_core/src/test_utils/http.rs`

`RequestAuthExt` (lines 113-135) is an auth concern misplaced in a network infrastructure crate. It was placed here as a workaround to avoid circular dependency on auth_middleware (see its doc comment). It is:
- Only **defined** in server_core, never used by any server_core tests
- Only consumed by routes_app test files (4 files, ~15 call sites)
- A header-injection helper that becomes obsolete with `Extension<AuthContext>`

**Action**: Delete `RequestAuthExt` trait, its `impl for Builder`, and the doc comment (lines 113-135). No server_core tests break.

Note: This temporarily breaks routes_app compilation (4 test files import `RequestAuthExt`). Fixed in Phase 5 when routes_app tests migrate to `RequestAuthContextExt` from auth_middleware.

#### Phase 3 Gate
```
cargo check -p server_core && cargo test -p server_core
```

---

### Phase 4: auth_middleware — AuthContext + middleware + internal consumers

This is where all the new code lives. AuthContext is first created and consumed here.

#### 4a. Create AuthContext enum
**File**: `crates/auth_middleware/src/auth_context.rs` (NEW)

- Define `AuthContext` enum with 4 variants and variant-specific fields (see design above)
- Add convenience methods (user_id, token, app_role, is_authenticated)
- Add test factory methods behind `test-utils` feature
- Add `RequestAuthContextExt` trait behind `test-utils` feature

**File**: `crates/auth_middleware/src/lib.rs`
- Add `mod auth_context;`
- Re-export `AuthContext` and (under test-utils) `RequestAuthContextExt`

#### 4b. Update auth_middleware functions to inject Extension
**File**: `crates/auth_middleware/src/auth_middleware.rs`

**`auth_middleware` function** (required auth, lines 121-227):
- Keep `remove_app_headers` call
- After bearer token validation: build `AuthContext::ApiToken { .. }` or `AuthContext::ExternalApp { .. }` instead of injecting headers
- After session validation: build `AuthContext::Session { .. }` instead of injecting headers
- Insert via `req.extensions_mut().insert(auth_context)`
- **Remove** all `req.headers_mut().insert(KEY_HEADER_BODHIAPP_*, ...)` calls

**`inject_optional_auth_info` function** (optional auth, lines 229-339):
- Keep `remove_app_headers` call
- On successful auth: build appropriate AuthContext variant and insert extension
- On no auth / failure: build `AuthContext::Anonymous` and insert extension
- **Remove** all header injection calls

#### 4c. Update api_auth_middleware
**File**: `crates/auth_middleware/src/api_auth_middleware.rs`

- Keep function signature: `(ResourceRole, Option<TokenScope>, Option<UserScope>)`
- Replace header reading with extension extraction:
  ```rust
  let auth_context = req.extensions().get::<AuthContext>()
    .ok_or(ApiAuthError::MissingAuth)?;
  ```
- Match on `AuthContext` variant for authorization checks

#### 4d. Update toolset_auth_middleware
**File**: `crates/auth_middleware/src/toolset_auth_middleware.rs`

- Replace `ExtractUserId`, `MaybeRole`, `MaybeAccessRequestId` extractors with extension extraction
- Match on variant to discriminate session vs OAuth flow
- Replace `headers.get(KEY_HEADER_BODHIAPP_AZP)` with `azp` from ExternalApp variant

#### 4e. Delete old extractors
**File**: `crates/auth_middleware/src/extractors.rs` — **DELETE**

- Remove all extractor types, HeaderExtractionError, helper functions
- Delete the entire file

**File**: `crates/auth_middleware/src/lib.rs`
- Remove `mod extractors;` and all extractor re-exports

#### 4f. Update auth_middleware tests

**`auth_middleware.rs` tests**: Currently tests assert on response headers (TestResponse checks x_resource_token, x_resource_role, etc.). These tests use a `test_handler_teapot` that reads headers from the request. Update to:
- Change test handler to extract `Extension<AuthContext>` from request instead of reading headers
- Assert on AuthContext variant and fields instead of header values

**`api_auth_middleware.rs` tests**: Currently inject `KEY_HEADER_BODHIAPP_ROLE/SCOPE` headers. Update to:
- Inject `Extension<AuthContext>` into request extensions instead (use a middleware layer that inserts the extension, or use `RequestAuthContextExt`)

**`toolset_auth_middleware.rs` tests**: Currently inject `KEY_HEADER_BODHIAPP_USER_ID`, `KEY_HEADER_BODHIAPP_ROLE`, `KEY_HEADER_BODHIAPP_AZP`, `KEY_HEADER_BODHIAPP_ACCESS_REQUEST_ID`. Update to:
- Inject `Extension<AuthContext>` with appropriate variant

#### Phase 4 Gate
```
cargo check -p auth_middleware && cargo test -p auth_middleware
```

---

### Phase 5: routes_app — Migrate handlers and tests

#### 5a. Migrate route handlers

Replace individual extractor params with `Extension<AuthContext>` and pattern match.

| File | Handlers | Current Extractors | Notes |
|------|----------|--------------------|-------|
| `routes_toolsets/toolsets.rs` | 8 handlers | ExtractUserId | All just need user_id |
| `routes_apps/handlers.rs` | 3 handlers | ExtractUserId, ExtractToken | Need user_id and/or token |
| `routes_api_token/mod.rs` | 3 handlers | ExtractToken + direct HeaderMap ROLE read | create_token needs role for privilege check |
| `routes_users/management.rs` | 3 handlers | ExtractToken | Need token for claims extraction |
| `routes_users/access_request.rs` | 4 handlers | ExtractUsername, ExtractUserId, MaybeRole, ExtractRole, ExtractToken | Most complex — multiple extractors per handler |
| `routes_users/user_info.rs` | 1 handler | Direct HeaderMap reads | Biggest cleanup — replace entire match block |
| `routes_auth/login.rs` | 1 handler | Direct HeaderMap TOKEN check | Simple is_authenticated check |

**Migration pattern**:
```rust
// Before:
async fn handler(
  ExtractUserId(user_id): ExtractUserId,
  ExtractToken(token): ExtractToken,
  State(state): State<Arc<dyn RouterState>>,
) -> Result<..., ApiError> {

// After:
async fn handler(
  Extension(auth_context): Extension<AuthContext>,
  State(state): State<Arc<dyn RouterState>>,
) -> Result<..., ApiError> {
  let AuthContext::Session { ref user_id, ref token, .. } = auth_context else {
    return Err(/* appropriate error */);
  };
```

**Special cases**:
- `user_info_handler`: Replace HeaderMap-based match with `match auth_context { Session {..} => ..., ApiToken {..} => ..., ExternalApp {..} => ..., Anonymous => logged_out }`.
- `create_token_handler`: Replace `headers.get(KEY_HEADER_BODHIAPP_ROLE)` with `AuthContext::Session { role, .. }` match. Session-only endpoint, reject non-Session.
- `login_handler`: Replace `headers.get(KEY_HEADER_BODHIAPP_TOKEN).is_some()` with `auth_context.is_authenticated()`.
- `user_request_access_handler`: Uses `MaybeRole` — `AuthContext::Session { .. }` means has role, `AuthContext::Anonymous` means no role.

#### 5b. Migrate routes_app tests

**Test migration pattern** (using `RequestAuthContextExt` from auth_middleware test-utils):
```rust
// Before:
let req = Request::get("/toolsets")
  .header(KEY_HEADER_BODHIAPP_USER_ID, "user123")
  .header(KEY_HEADER_BODHIAPP_ROLE, ResourceRole::User.to_string())
  .body(Body::empty())?;

// After:
let req = Request::get("/toolsets")
  .body(Body::empty())?
  .with_auth_context(AuthContext::test_session("user123", "user@example.com", ResourceRole::User));
```

**Test files to update** (currently import `RequestAuthExt` from server_core — replace with `RequestAuthContextExt` from auth_middleware):
- `routes_api_token/tests/api_token_test.rs` — 6 uses of `with_user_auth`
- `routes_users/tests/access_request_test.rs` — 3 uses of `with_user_auth`
- `routes_users/tests/user_info_test.rs` — 4 uses of `with_user_auth`, 2 uses of `with_api_token`
- `routes_toolsets/tests/toolsets_test.rs` — 2 uses of `with_user_auth`

**Tests that use direct header injection** (also need migration):
- Tests that manually set `KEY_HEADER_BODHIAPP_*` headers instead of using `RequestAuthExt`

#### Phase 5 Gate
```
cargo check -p routes_app && cargo test -p routes_app
```

---

### Phase 6: server_app — Integration verification

**server_app tests** use real HTTP servers with full middleware stack. Since the middleware now injects `Extension<AuthContext>` instead of headers, and handlers consume extensions, these should work with **no test code changes** — the middleware processes real auth tokens and builds the AuthContext.

Only references to auth_middleware in server_app source: session key constants (`SESSION_KEY_ACCESS_TOKEN`, `SESSION_KEY_REFRESH_TOKEN`) — unrelated to this refactoring.

#### Phase 6 Gate
```
cargo check -p server_app && cargo test -p server_app
```

---

### Phase 7: lib_bodhiserver, lib_bodhiserver_napi, bodhi/src-tauri — Verify compilation

**lib_bodhiserver**: Only references auth_middleware in Cargo.toml (as a dependency). No Rust source code references extractors or header constants. Compilation verification only.

**lib_bodhiserver_napi**: Has `AuthContext.tsx` in test-oauth-app (React, not Rust — unrelated). No Rust source code changes needed.

**bodhi/src-tauri**: Depends transitively on auth_middleware through routes_app. Compilation verification only.

#### Phase 8 Gate
```
cargo check -p lib_bodhiserver
cargo check -p lib_bodhiserver_napi
cargo check -p bodhi --features native
make test.backend  # full suite
```

---

### Phase 8: Cleanup and tech debt

#### 8a. Clean up unused header constants
**File**: `crates/auth_middleware/src/auth_middleware.rs`

Review which `KEY_HEADER_BODHIAPP_*` constants are still needed:
- Keep: `KEY_PREFIX_HEADER_BODHIAPP` (used by `remove_app_headers`)
- Keep all individual constants used in `remove_app_headers` (they still need to be stripped from incoming requests)
- Remove any that are no longer referenced anywhere

#### 8b. Add tech debt items
**File**: `ai-docs/claude-plans/20260210-access-request/tech-debt.md`

Append:
1. **Single middleware**: Merge `auth_middleware` and `inject_optional_auth_info` into one middleware. Pros: simpler architecture, eliminates code duplication (~100 lines). Cons: auth requirement enforcement moves entirely to api_auth_middleware.
2. **Route policy with AuthContext list**: Replace `api_auth_middleware(ResourceRole, Option<TokenScope>, Option<UserScope>)` with `api_auth_middleware(allowed: &[AuthContext])`. Pros: self-documenting, type-safe. Cons: requires matching variants with minimum levels.
3. **Toolset auth full integration**: Restructure toolset auth business logic to use AuthContext pattern consistently. Pros: consistent auth pattern. Cons: complex domain logic (access request validation, azp matching) hard to generalize.

#### 8c. Update CLAUDE.md / PACKAGE.md documentation
- Update `crates/auth_middleware/CLAUDE.md` to reflect AuthContext + Extension pattern
- Update `crates/routes_app/CLAUDE.md` extractor documentation

---

## Key Files Summary

| Phase | File | Action |
|-------|------|--------|
| 3 | `crates/server_core/src/test_utils/http.rs` | Remove misplaced `RequestAuthExt` (auth concern, no server_core tests use it) |
| 4 | `crates/auth_middleware/src/auth_context.rs` | **NEW** — AuthContext enum + test factories + RequestAuthContextExt |
| 4 | `crates/auth_middleware/src/lib.rs` | Update exports |
| 4 | `crates/auth_middleware/src/auth_middleware.rs` | Replace header injection with Extension |
| 4 | `crates/auth_middleware/src/api_auth_middleware.rs` | Read from Extension instead of headers |
| 4 | `crates/auth_middleware/src/toolset_auth_middleware.rs` | Read from Extension instead of extractors |
| 4 | `crates/auth_middleware/src/extractors.rs` | **DELETE** |
| 5 | `crates/routes_app/src/routes_users/user_info.rs` | Match on AuthContext variants |
| 5 | `crates/routes_app/src/routes_users/access_request.rs` | Replace 5 extractors with Extension |
| 5 | `crates/routes_app/src/routes_users/management.rs` | Replace ExtractToken with Extension |
| 5 | `crates/routes_app/src/routes_api_token/mod.rs` | Replace ExtractToken + HeaderMap |
| 5 | `crates/routes_app/src/routes_toolsets/toolsets.rs` | Replace ExtractUserId with Extension |
| 5 | `crates/routes_app/src/routes_apps/handlers.rs` | Replace ExtractUserId/ExtractToken |
| 5 | `crates/routes_app/src/routes_auth/login.rs` | Replace HeaderMap TOKEN check |
| 5 | ~4 test files in routes_app | Migrate from RequestAuthExt to RequestAuthContextExt |
| 8 | `ai-docs/claude-plans/20260210-access-request/tech-debt.md` | Add 3 tech debt items |
