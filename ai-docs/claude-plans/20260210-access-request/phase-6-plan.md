---
name: Frontend review-approve page
overview: "Phase 6 of access request revamp: rename backend API paths for correct prefix conventions, implement frontend review/approve page with hooks, MSW mocking, and component tests. Executed in 5 phases, each with tests and a local commit."
todos:
  - id: phase-1
    content: "Phase 1: Backend API path rename + review URL fix. Commit."
    status: completed
  - id: phase-2
    content: "Phase 2: Regenerate ts-client, add route constant, create API hooks + MSW handlers + test fixtures. Commit."
    status: completed
  - id: phase-3
    content: "Phase 3: Implement review page with data-testid/data-test-* attrs, tool instance selection UI. Commit."
    status: completed
  - id: phase-4
    content: "Phase 4: Add login return URL support via sessionStorage in AppInitializer + callback. Commit."
    status: completed
  - id: phase-5
    content: "Phase 5: Write 19 comprehensive component tests with MSW, update plan doc. Commit."
    status: completed
isProject: false
---

# Phase 6: Frontend Access Request Review/Approve Page

## Execution Approach

Each phase is implemented by a **specialized sub-agent** with full context space, then verified and committed before moving to the next phase.

**Test commands run after each phase:**

- Backend changes: `cargo test -p objs -p services -p server_core -p auth_middleware -p routes_app -p server_app`
- Frontend changes: `cd crates/bodhi && npm run test`
- Formatting: `cargo fmt` and `cd crates/bodhi && npm run format`

**After tests pass:** local git commit, then move to next phase.

---

## Context

Third-party apps create access requests via `POST /bodhi/v1/apps/request-access` (verb endpoint) and receive a `review_url`. The user opens this URL (popup or redirect), logs in if needed, reviews requested tools, selects tool instances, and approves or denies.

### Key Path Design Decisions (Discovered During Implementation)

Two distinct path prefixes are used intentionally to control access:

- `**/apps/` prefix** — endpoints called directly by 3rd-party apps (unauthenticated, require `app_client_id`)
- **No `/apps/` prefix** — endpoints called by the frontend review page (session-authenticated)

**Final API paths:**


| Endpoint              | Path                                         | Auth                            | Called By      |
| --------------------- | -------------------------------------------- | ------------------------------- | -------------- |
| Create access request | `POST /bodhi/v1/apps/request-access`         | Unauthenticated (app_client_id) | 3rd-party apps |
| Poll status           | `GET /bodhi/v1/apps/access-requests/{id}`    | Unauthenticated (app_client_id) | 3rd-party apps |
| Get review data       | `GET /bodhi/v1/access-requests/{id}/review`  | Session auth                    | Frontend page  |
| Approve               | `PUT /bodhi/v1/access-requests/{id}/approve` | Session auth                    | Frontend page  |
| Deny                  | `POST /bodhi/v1/access-requests/{id}/deny`   | Session auth                    | Frontend page  |


**Frontend review page URL:** `/ui/apps/access-requests/review?id={uuid}`

**Review URL generated by backend:** `{frontend_url}/ui/apps/access-requests/review?id={uuid}`

---

## Phase 1: Backend API Path Rename + Review URL Fix ✅

**Status:** Completed

**Scope:** Rust backend only. Rename access request endpoints for correct prefix conventions and fix review URL.

### Deviation from Original Plan

The original plan assumed all endpoints should move under `/apps/access-requests/` (plural). During implementation, the user clarified the path prefix design:

- `POST /apps/request-access` — stays unchanged (verb endpoint for 3rd-party apps to create requests)
- `GET /apps/access-requests/{id}` — keeps `/apps/` prefix (called by apps for polling, singular→plural only)
- Review/approve/deny endpoints — **drop** the `/apps/` prefix to `/access-requests/` (called by frontend, not apps)

### Actual Changes

**1a. Endpoint constants** in `crates/routes_app/src/routes_apps/handlers.rs`:

```rust
ENDPOINT_APPS_REQUEST_ACCESS     = "/bodhi/v1/apps/request-access"       // UNCHANGED
ENDPOINT_APPS_ACCESS_REQUESTS_ID = "/bodhi/v1/apps/access-requests/{id}" // singular->plural, kept /apps/
ENDPOINT_ACCESS_REQUESTS_REVIEW  = "/bodhi/v1/access-requests/{id}/review"  // DROPPED /apps/
ENDPOINT_ACCESS_REQUESTS_APPROVE = "/bodhi/v1/access-requests/{id}/approve" // DROPPED /apps/
ENDPOINT_ACCESS_REQUESTS_DENY    = "/bodhi/v1/access-requests/{id}/deny"    // DROPPED /apps/
```

**1b. Route registration** in `crates/routes_app/src/routes.rs`: updated imports and route registrations.

**1c. Type comments** in `crates/routes_app/src/routes_apps/types.rs`: updated path references in doc comments.

**1d. Review URL** in `crates/services/src/access_request_service/service.rs`: updated `build_review_url` to `{frontend_url}/ui/apps/access-requests/review?id={uuid}`.

**1e. E2E test path refs** — the E2E tests referenced the create endpoint (`/apps/request-access`), which was temporarily changed but then reverted since the create endpoint path is unchanged.

**1f. OpenAPI spec** regenerated via `cargo run --package xtask openapi`.

### Verification

All backend tests pass. `cargo fmt` applied.

---

## Phase 2: TypeScript Client + API Hooks + MSW Handlers + Test Fixtures ✅

**Status:** Completed

**Scope:** Regenerate ts-client, create frontend API hooks, MSW handlers, and test fixtures.

### Actual Changes

**2a. ts-client** regenerated via `make build.ts-client`. New paths appear in generated types.

**2b. Route constant** in `crates/bodhi/src/lib/constants.ts`:

```typescript
export const ROUTE_APP_REVIEW_ACCESS = '/ui/apps/access-requests/review';
```

Note: Uses `/ui/apps/access-requests/review` (not `/ui/access-requests/review` as originally planned).

**2c. API hooks** in `crates/bodhi/src/hooks/useAppAccessRequests.ts`:

- `useAppAccessRequestReview(id)` — `useQuery` for `GET /bodhi/v1/access-requests/{id}/review`
- `useApproveAppAccessRequest()` — `useMutationQuery` for `PUT /bodhi/v1/access-requests/{id}/approve`
- `useDenyAppAccessRequest()` — `useMutationQuery` for `POST /bodhi/v1/access-requests/{id}/deny`
- Local TypeScript interfaces: `AccessRequestReviewResponse`, `ToolTypeReviewInfo`, `ToolInstanceInfo`, `ApproveAccessRequestBody`, `ToolApprovalItem`, `RequestedResources`

Note: Hooks call `/access-requests/` (no `/apps/` prefix) since these are frontend-facing endpoints.

**2d. MSW handlers** in `crates/bodhi/src/test-utils/msw-v2/handlers/app-access-requests.ts`:

- `mockAppAccessRequestReview` / `mockAppAccessRequestReviewError` — GET review
- `mockAppAccessRequestApprove` / `mockAppAccessRequestApproveError` — PUT approve
- `mockAppAccessRequestDeny` / `mockAppAccessRequestDenyError` — POST deny

**2e. Test fixtures** in `crates/bodhi/src/test-fixtures/app-access-requests.ts`:

- `mockDraftReviewResponse`, `mockDraftNoInstancesResponse`, `mockApprovedReviewResponse`
- `mockExpiredReviewResponse`, `mockDeniedReviewResponse`, `mockDraftRedirectResponse`
- `mockDraftMultiToolResponse` — multiple tool types (added beyond original plan)
- `MOCK_REQUEST_ID`, `MOCK_APP_CLIENT_ID` convenience constants

---

## Phase 3: Review Page Implementation ✅

**Status:** Completed

**Scope:** Implement the review/approve/deny page UI with full data-testid coverage.

### Page: `crates/bodhi/src/app/ui/apps/access-requests/review/page.tsx`

Note: Page is at `/ui/apps/access-requests/review` (not `/ui/access-requests/review` as originally planned). The `/apps/` prefix in the frontend URL is intentional — this page is opened by 3rd-party apps via the review URL.

**Components implemented:**

- `ReviewAccessRequestPage` — wrapper with `AppInitializer allowedStatus="ready" authenticated={true}`
- `ReviewContent` — main content, extracts `id` from `useSearchParams()`
- `ToolTypeCard` — per-tool-type card with instance select dropdown
- `NonDraftStatus` — handles approved/denied/expired states

**Non-draft state handling:**

- `flow_type === "popup"` → `window.close()` (via useEffect)
- `flow_type === "redirect"` → shows status badge (backend redirect_url not available in review response, 3rd-party app polls for status changes)

**Draft state - Review UI:**

- Uses Shadcn `Card`, `Button`, `Select`, `Badge`, `Alert`, `Skeleton`
- Tool instance selection with disabled states for unconfigured instances
- "No instances configured" alert when tool type has no instances
- "All instances disabled or missing API keys" alert when no valid instances
- Approve button disabled until all tool types have a valid instance selected
- Loading spinners in Approve/Deny buttons during submission

**Data-testid / data-test- attributes:** All as originally planned, plus:

- `data-testid="review-no-valid-instances-{tool_type}"` — when all instances are disabled/missing keys
- `data-testid="review-instance-option-{instance_id}"` — per select option

---

## Phase 4: Login Return URL Support ✅

**Status:** Completed

**Scope:** Enable the review page to redirect to login and return after authentication.

### Actual Changes

**4a. Store return URL** in `crates/bodhi/src/components/AppInitializer.tsx`:

- Before `router.push(ROUTE_LOGIN)`, stores `window.location.href` in `sessionStorage` under key `bodhi-return-url`
- Uses `typeof window !== 'undefined'` guard for SSR safety
- This is a generic mechanism — any authenticated page that triggers login redirect will benefit

**4b. Consume return URL** in `crates/bodhi/src/app/ui/auth/callback/page.tsx`:

- In `useOAuthCallback.onSuccess`, checks `sessionStorage.getItem('bodhi-return-url')` first
- If present, redirects via `handleSmartRedirect(returnUrl, router)` and removes the item
- Otherwise falls through to existing backend `location` redirect logic

**4c. Existing tests** — all 745 existing tests continued to pass without modification. The sessionStorage logic is additive and doesn't affect existing behavior when no return URL is stored.

---

## Phase 5: Comprehensive Component Tests + Plan Doc Update ✅

**Status:** Completed (19 tests, all passing)

**Scope:** Full test coverage for the review page using Vitest + MSW.

### Deviation: No Page Object Model

The original plan called for a separate `ReviewAccessPage.ts` page object model. In practice, direct `screen.getByTestId()` calls were sufficient and more consistent with the existing test patterns in the codebase (e.g., `access-requests/page.test.tsx`). A POM was not created.

### Test File: `crates/bodhi/src/app/ui/apps/access-requests/review/page.test.tsx`

**Loading & error states (4 tests):**

- ✅ shows error page when no `id` query param
- ✅ shows loading skeleton while fetching review data
- ✅ shows error page when API returns 404
- ✅ shows error page when API returns 500

**Draft review form (7 tests):**

- ✅ renders app name and description from review data
- ✅ renders tool type cards with correct names and descriptions
- ✅ renders instance select dropdowns with available instances
- ✅ shows "No instances configured" when tool type has no instances
- ✅ Approve button disabled when no valid instances exist
- ✅ Approve button disabled until all tool types have instance selected
- ✅ Approve button becomes enabled after selecting valid instance

**Approve flow (2 tests):**

- ✅ clicking Approve calls PUT with correct body, then `window.close()` for popup flow
- ✅ on approve error, button re-enables (toast error via mocked `useToastMessages`)

**Deny flow (2 tests):**

- ✅ clicking Deny calls POST to deny endpoint, then `window.close()` for popup flow
- ✅ on deny error, button re-enables

**Non-draft states (3 tests):**

- ✅ approved status with popup flow calls `window.close()`
- ✅ denied status with redirect flow shows status badge
- ✅ expired status with redirect flow shows status badge

**Multi-tool types (1 test):**

- ✅ renders multiple tool type cards

**Test infrastructure:**

- Mocks `next/navigation` (`useRouter`, `useSearchParams`, `usePathname`)
- Mocks `useToastMessages` for toast assertions
- Mocks `window.close` for popup flow testing
- Uses MSW handlers and fixtures from Phase 2

### Fix Applied

Fixed React controlled/uncontrolled Select warning by defaulting `selectedInstance` to `''` instead of `undefined` via `value={selectedInstance ?? ''}`.

---

## Files Summary (Actual)

### Phase 1 (Backend) — 5 files modified + openapi.json regenerated

- `crates/routes_app/src/routes_apps/handlers.rs` — rename endpoint constants, update utoipa paths
- `crates/routes_app/src/routes.rs` — update imports and route registrations
- `crates/routes_app/src/routes_apps/types.rs` — update doc comments
- `crates/services/src/access_request_service/service.rs` — fix `build_review_url` path
- `openapi.json` — regenerated via `cargo run --package xtask openapi`

Note: E2E test files were temporarily changed but then reverted since `POST /apps/request-access` was unchanged.

### Phase 2 (Hooks + MSW + Fixtures) — 4 files created/modified

- `crates/bodhi/src/lib/constants.ts` — added `ROUTE_APP_REVIEW_ACCESS`
- `crates/bodhi/src/hooks/useAppAccessRequests.ts` — **created** (hooks + TypeScript interfaces)
- `crates/bodhi/src/test-utils/msw-v2/handlers/app-access-requests.ts` — **created** (6 MSW handler functions)
- `crates/bodhi/src/test-fixtures/app-access-requests.ts` — **created** (7 fixture objects + 2 constants)

### Phase 3 (Review Page) — 1 file created

- `crates/bodhi/src/app/ui/apps/access-requests/review/page.tsx` — **created** (347 lines)

### Phase 4 (Login Return URL) — 2 files modified

- `crates/bodhi/src/components/AppInitializer.tsx` — store return URL in sessionStorage before login redirect
- `crates/bodhi/src/app/ui/auth/callback/page.tsx` — consumae return URL after login success

### Phase 5 (Tests) — 1 file created, 1 file modified

- `crates/bodhi/src/app/ui/apps/access-requests/review/page.test.tsx` — **created** (19 tests)
- `crates/bodhi/src/app/ui/apps/access-requests/review/page.tsx` — fix controlled/uncontrolled Select

### Test Results

- Frontend: 764 tests pass (72 files, 19 new)
- Backend: all tests pass across all crates

