# Plan: Post-Review Fixes for PostgreSQL Session Support

## Context
Commit `48f6673b` restructured `session_service` to support both SQLite and PostgreSQL backends. A thorough review found 3 Critical, 11 Important, and 24 Nice-to-have issues. This plan addresses the actionable fixes and creates TECHDEBT files for deferred items.

User decisions on key questions:
- **CI**: Defer PG test integration to TECHDEBT. Keep PG service in build.yml, note tests not running.
- **Docker**: Hard requirement for `make test.backend`. Document it.
- **Cookie security**: Defer to crate-level TECHDEBT (`crates/services/`).
- **Dual pool**: Defer to TECHDEBT. Will be resolved when app DB migrates to dual-backend.
- **AppSessionStoreExt duplication**: Defer to TECHDEBT.
- **SQL `$1` params**: Keep + add documenting comment.
- **Migration versioning**: Idempotent is sufficient, no change needed.
- **Settings editability**: Known, no action. Already tracked in `routes_app/TECHDEBT.md`.

---

## Milestone 1: services crate

### 1.1 Fix `InnerStoreShared` Option anti-pattern → enum (S1, S16)

**File**: `crates/services/src/session_service/session_store.rs`

Replace `InnerStoreShared` struct with proper enum:
```rust
#[derive(Clone)]
enum StoreInner {
  Sqlite(SqliteStore),
  Postgres(PostgresStore),
}
```

Update `SessionStoreBackend`:
- Change `inner: InnerStoreShared` to `inner: StoreInner`
- Replace all `if let Some(store) / else if let Some(store) / else` with `match self.inner { ... }`
- `save()`, `load()`, `delete()` become exhaustive match arms
- `Debug` impl uses match on `StoreInner`
- Update `new_sqlite()` and `new_postgres()` constructors

### 1.2 Add `$1` parameter documentation comment (S3)

**Files**: `crates/services/src/session_service/session_store.rs`, `crates/services/src/session_service/session_service.rs`

Add comment above queries using `$1`:
```rust
// Note: $1/$2 positional parameters work with SQLite via AnyPool because
// sqlx's AnyPool translates PostgreSQL-style positional params to ?-style
// for SQLite. Parameterized tests (test_session_service.rs) verify both backends.
```

### 1.3 Fix temp_dir leak in tests (S4)

**File**: `crates/services/src/test_session_service.rs`

Change `create_session_service()` to return `(DefaultSessionService, Option<TempDir>)`:
- SQLite branch: return `(service, Some(temp_dir))` instead of `std::mem::forget(temp_dir)`
- Postgres branch: return `(service, None)`
- Update all test functions to destructure: `let (service, _temp_dir) = create_session_service(...).await;`

### 1.4 Fix test conventions (S9, S18)

**File**: `crates/services/src/test_session_service.rs`

- Add `use anyhow_trace::anyhow_trace;` import
- Add `#[anyhow_trace]` to all test functions
- Change return types to `-> anyhow::Result<()>`
- Replace `.unwrap()` with `?`
- Swap `assert_eq!` to `assert_eq!(expected, actual)` order

### 1.5 Add .env.test.example (I3)

**File**: `crates/services/.env.test.example` (NEW)
```
INTEG_TEST_SESSION_PG_URL=postgres://bodhi_test:bodhi_test@localhost:54320/bodhi_sessions
```

### 1.6 Create services TECHDEBT (S8)

**File**: `crates/services/TECHDEBT.md` (NEW)
- Cookie security: `with_secure(false)` hardcoded in `session_layer()`. Should be configurable based on BODHI_SCHEME or deployment context for production/cluster deployments.

### 1.7 Update services PACKAGE.md (D4)

**File**: `crates/services/src/test_utils/PACKAGE.md`
- `SqliteSessionService` → `DefaultSessionService` in code examples

**Verify milestone**: `cargo test -p services`

---

## Milestone 2: routes_app crate

### 2.1 Update CLAUDE.md stale references (D1)

**File**: `crates/routes_app/CLAUDE.md`
- `SqliteSessionService` → `DefaultSessionService`
- `with_sqlite_session_service` → `with_default_session_service`
- `session_service.session_store.create(...)` → `session_service.get_session_store().create(...)`
- Table: `Custom router with real \`SqliteSessionService\`` → `Custom router with real \`DefaultSessionService\``

### 2.2 Update router.rs stale comments (D2, D3)

**File**: `crates/routes_app/src/test_utils/router.rs`
- Line 98 comment: `SqliteSessionService` → `DefaultSessionService`
- Line 63 doc comment: `AppSessionStore` → `SessionStoreBackend`

**Verify milestone**: `cargo test -p services -p routes_app`

---

## Milestone 3: lib_bodhiserver crate

### 3.1 Update PACKAGE.md (D5)

**File**: `crates/lib_bodhiserver/src/test_utils/PACKAGE.md`
- `session_db_path()` → `session_db_url()`

**Verify milestone**: `cargo test -p services -p routes_app -p lib_bodhiserver`

---

## Milestone 4: ci_optims crate

### 4.1 Fix tower-sessions-sqlx-store features (I7)

**File**: `crates/ci_optims/Cargo.toml`

Add features:
```toml
tower-sessions-sqlx-store = { workspace = true, features = ["sqlite", "postgres"] }
```

**Verify milestone**: `cargo check -p ci_optims`

---

## Milestone 5: Infrastructure & Documentation

### 5.1 Create `.github/TECHDEBT.md` (NEW)
- CI PostgreSQL test integration: PG service provisioned in build.yml but no tests run against it yet
- Need to add `cargo test` step with `INTEG_TEST_SESSION_PG_URL=postgres://bodhi_test:bodhi_test@localhost:54320/bodhi_sessions`
- Health check alignment: use `pg_isready -U bodhi_test -d bodhi_sessions` (align with docker-compose)

### 5.2 Create `ai-docs/claude-plans/20260224-posgres/TECHDEBT.md` (NEW)
- Dual pool → typed pool: once app DB supports postgres, switch session service to typed pools only (remove AnyPool PoC)
- AppSessionStoreExt trait duplication: consolidate with SessionService or make private

### 5.3 Document Docker requirement in root CLAUDE.md

**File**: `CLAUDE.md` (project root)

Update `make test.backend` line:
```
- `make test.backend` - Run Rust backend tests (requires Docker for PostgreSQL test dependencies; runs `make test.deps.up` automatically)
```

**Verify milestone**: `make test.backend` (full backend test suite)

---

## Milestone 6: Final verification

1. Grep for stale references: `rg "SqliteSessionService|AppSessionStore[^E]|session_db_path" --type md`
2. `make test.backend` - Full backend (already run in M5 but confirm clean)

---

## Files Modified (summary)
- `crates/services/src/session_service/session_store.rs` — enum refactor + $1 comment
- `crates/services/src/session_service/session_service.rs` — $1 comment
- `crates/services/src/test_session_service.rs` — temp_dir fix, conventions
- `crates/services/.env.test.example` — NEW
- `crates/services/TECHDEBT.md` — NEW
- `crates/services/src/test_utils/PACKAGE.md` — doc update
- `crates/routes_app/CLAUDE.md` — doc update
- `crates/routes_app/src/test_utils/router.rs` — comment updates
- `crates/lib_bodhiserver/src/test_utils/PACKAGE.md` — doc update
- `crates/ci_optims/Cargo.toml` — features
- `.github/TECHDEBT.md` — NEW
- `ai-docs/claude-plans/20260224-posgres/TECHDEBT.md` — NEW
- `CLAUDE.md` (project root) — Docker note
