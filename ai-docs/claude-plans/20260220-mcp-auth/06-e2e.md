# MCP OAuth - E2E Tests

## Task

✅ **COMPLETED** - Build test MCP OAuth server infrastructure and Playwright E2E specs covering pre-registered OAuth, dynamic client registration, header auth, and 3rd-party access request flows.

**Refactor Impact**: Updated API calls and assertions to use unified auth config endpoints and simplified `auth_type` values.

## Files

### Test MCP OAuth Server
| File | Purpose |
|------|---------|
| `crates/lib_bodhiserver_napi/test-mcp-oauth-server/src/index.ts` | Entry point: Express app, MCP endpoints, server startup |
| `crates/lib_bodhiserver_napi/test-mcp-oauth-server/src/oauth.ts` | OAuth 2.1 authorization server (~350 lines) |
| `crates/lib_bodhiserver_napi/test-mcp-oauth-server/src/mcp-server.ts` | MCP server with OAuth-protected Streamable HTTP transport (~142 lines) |

### E2E Specs
| File | Purpose |
|------|---------|
| `crates/lib_bodhiserver_napi/tests-js/specs/mcps/mcps-oauth-auth.spec.mjs` | Pre-registered OAuth flows (4 specs) |
| `crates/lib_bodhiserver_napi/tests-js/specs/mcps/mcps-oauth-dcr.spec.mjs` | Dynamic client registration flows (3 specs) |
| `crates/lib_bodhiserver_napi/tests-js/specs/mcps/mcps-header-auth.spec.mjs` | Header auth flows (3 specs) |

### Fixtures and Page Objects
| File | Purpose |
|------|---------|
| `crates/lib_bodhiserver_napi/tests-js/fixtures/mcpFixtures.mjs` | OAuth test data constants and factory methods |
| `crates/lib_bodhiserver_napi/tests-js/pages/McpsPage.mjs` | Page object with OAuth-specific methods |
| `crates/lib_bodhiserver_napi/tests-js/pages/OAuthTestApp.mjs` | External app page object for 3rd-party flows |
| `crates/lib_bodhiserver_napi/tests-js/pages/sections/ConfigSection.mjs` | OAuth form config section |
| `crates/lib_bodhiserver_napi/tests-js/pages/sections/OAuthSection.mjs` | OAuth flow section (login, consent, token) |
| `crates/lib_bodhiserver_napi/tests-js/pages/sections/AccessCallbackSection.mjs` | Access request callback handling |

## Test MCP OAuth Server Architecture

Express-based OAuth 2.1 + MCP server with two modes:

- **Pre-registered mode** (port 55174): Uses fixed client_id/secret from env vars
- **DCR mode** (port 55175, `--dcr` flag): Supports dynamic client registration

### OAuth Endpoints (oauth.ts)

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/.well-known/oauth-authorization-server` | GET | OAuth metadata (includes `registration_endpoint` only in DCR mode) |
| `/.well-known/oauth-protected-resource` | GET | Protected resource metadata (DCR mode only) |
| `/authorize` | GET | Authorization form (HTML with approve button) |
| `/authorize` | POST | Process approval, generate auth code, redirect |
| `/token` | POST | Exchange code or refresh token for access token |
| `/register` | POST | Dynamic Client Registration (DCR mode only) |

Features: PKCE S256 validation, Basic Auth client authentication, authorization codes valid 600s, access tokens expire 3600s, refresh token support. Scopes: `mcp:tools`, `mcp:read`.

### MCP Endpoints (mcp-server.ts + index.ts)

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/mcp` | POST | Initialize or continue MCP session |
| `/mcp` | GET | Continue streaming session |
| `/mcp` | DELETE | Cleanup session |

OAuth token validation on every request. Uses MCP SDK's `StreamableHTTPServerTransport`. Tools: `echo` (returns "echo: {text}"), `get_server_info` (returns server metadata). Session management via `Mcp-Session-Id` header.

## Environment Variables

| Variable | Default | Purpose |
|----------|---------|---------|
| `TEST_MCP_OAUTH_CLIENT_ID` | `test-mcp-client-id` | Pre-registered client ID |
| `TEST_MCP_OAUTH_CLIENT_SECRET` | `test-mcp-client-secret` | Pre-registered client secret |
| `TEST_MCP_OAUTH_PORT` | `55174` | Pre-registered server port |
| `TEST_MCP_OAUTH_DCR_PORT` | `55175` | DCR server port |

## Fixtures (mcpFixtures.mjs)

### Constants
- `OAUTH_MCP_URL` = `http://localhost:55174/mcp`
- `OAUTH_DCR_MCP_URL` = `http://localhost:55175/mcp`
- `OAUTH_EXPECTED_TOOL` = `echo`

### Factory Methods
- `createOAuthServerData()` - server entry: URL, timestamped name
- `createOAuthInstanceData()` - MCP instance: timestamped name/slug
- `createOAuthConfigData()` - pre-registered config: client_id, client_secret, endpoints, scopes
- `createDcrServerData()` / `createDcrInstanceData()` - DCR equivalents

## McpsPage OAuth Methods (McpsPage.mjs)

✅ **UPDATED** - API helpers use unified endpoints

### API-driven helpers

**Git diff changes:**
```javascript
// createAuthHeaderViaApi - now uses unified endpoint with type discriminator
-        const resp = await fetch(`${baseUrl}/bodhi/v1/mcps/auth-headers`, {
+        const resp = await fetch(`${baseUrl}/bodhi/v1/mcps/auth-configs`, {
           method: 'POST',
           body: JSON.stringify({
+            type: 'header',
             name: name || 'Header',
             mcp_server_id: serverId,
             // ...

// createOAuthConfigViaApi - unified endpoint + type discriminator
-        const resp = await fetch(`${baseUrl}/bodhi/v1/mcp-servers/${serverId}/oauth-configs`, {
+        const resp = await fetch(`${baseUrl}/bodhi/v1/mcps/auth-configs`, {
           method: 'POST',
-          body: JSON.stringify(config),
+          body: JSON.stringify({ ...config, type: 'oauth', mcp_server_id: serverId }),

// dynamicRegisterViaApi - removed serverId parameter
-  async dynamicRegisterViaApi(serverId, { registrationEndpoint, redirectUri, scopes }) {
+  async dynamicRegisterViaApi({ registrationEndpoint, redirectUri, scopes }) {
-          `${baseUrl}/bodhi/v1/mcp-servers/${serverId}/oauth-configs/dynamic-register`,
+          `${baseUrl}/bodhi/v1/mcps/oauth/dynamic-register`,
```

Updated helpers:
- `createOAuthConfigViaApi(serverId, config)` - POST to `/mcps/auth-configs` with `type: 'oauth'`
- `createAuthHeaderViaApi(serverId, { name, headerKey, headerValue })` - POST to `/mcps/auth-configs` with `type: 'header'`
- `discoverMcpEndpointsViaApi(mcpServerUrl)` - POST to discover-mcp endpoint (no change)
- `dynamicRegisterViaApi({ registrationEndpoint, redirectUri, scopes })` - POST to `/mcps/oauth/dynamic-register` (serverId removed)

### UI interaction helpers
- `selectAuthConfigPublic()` / `selectAuthConfigById(configId)` - dropdown selection
- `expectAuthConfigState(type)` - verify dropdown state
- `clickOAuthConnect()` / `expectOAuthConnected()` / `expectOAuthDisconnected()` / `clickDisconnect()` - OAuth flow

### Composite workflows
- `createMcpInstanceWithOAuth({ serverName, name, slug, authConfigId, approveSelector })` - full UI OAuth flow: navigate, select server, select config, authorize (clicks approve button on OAuth server), callback, fill details, fetch tools, create
- `createMcpInstanceWithHeaderAuth({ serverName, name, slug, authConfigId, description })` - header auth creation flow

## E2E Specs

### mcps-oauth-auth.spec.mjs (Pre-registered OAuth, 4 specs)

✅ **UPDATED** - Assertions use `auth_type: 'oauth'` instead of `'oauth-pre-registered'`

1. **UI-driven OAuth flow**: Create server, create config via API, select config in UI, authorize via popup (click approve button at `[data-testid="approve-btn"]`), callback exchanges token, fill MCP details, fetch tools, create instance, execute `echo` tool in playground
2. **3rd-party access request**: Create OAuth MCP, configure external app OAuth request (with `mcp_servers` in requested scope), submit access request, approve with OAuth MCP, exchange tokens, verify REST API tool execution
   - **Updated assertion**: `expect(mcpData.auth_type).toBe('oauth')` (was `'oauth-pre-registered'`)
3. **Edit OAuth MCP**: Navigate to edit, verify connected card, disconnect, update saves without token
4. **Denied access request**: External app access request denied, callback receives error state

### mcps-oauth-dcr.spec.mjs (Dynamic Client Registration, 3 specs)

✅ **UPDATED** - API calls and assertions updated

1. **UI-driven DCR flow**: Create server, call `discoverMcpEndpointsViaApi()` (fetches `.well-known/oauth-authorization-server`), verify response has `registration_endpoint`, call `dynamicRegisterViaApi()` (no serverId param), verify `client_id` matches `^dyn-` pattern, create OAuth config with DCR data, authorize, create MCP, verify playground
2. **Edit DCR MCP**: Same disconnect/update pattern as pre-reg
3. **DCR access request**: Same 3rd-party flow as pre-reg but with DCR credentials
   - **Updated assertion**: `expect(mcpData.auth_type).toBe('oauth')` (was `'oauth-dynamic'`)

**Git diff change in all DCR specs:**
```javascript
-        const dcrResult = await mcpsPage.dynamicRegisterViaApi(serverId, {
+        const dcrResult = await mcpsPage.dynamicRegisterViaApi({
           registrationEndpoint: discovery.registration_endpoint,
           redirectUri,
           scopes: discovery.scopes_supported?.join(' ') || undefined,
         });
```

### mcps-header-auth.spec.mjs (Header Auth, 3 specs)

1. **Create with header auth**: Create header config via API (`headerKey: 'Authorization'`, `headerValue: 'Bearer {API_KEY}'`), select from dropdown, fetch tools, create, execute in playground
2. **Edit switch auth**: Switch header auth to public and back, verify auth config state
3. **Access request with header auth**: 3rd-party app REST execution with header-auth MCP

## Playwright Configuration

```
webServer entries (playwright.config.mjs):
  - Bodhi server: port 51135
  - OAuth test app: port 55173
  - Pre-registered OAuth server: port 55174
  - DCR OAuth server: port 55175
```

All servers start fresh with `reuseExistingServer: false`.

## Test Flow Patterns

### Pattern 1: Pre-registered OAuth
Config created via API -> select in UI dropdown -> click "Authorize" -> approve on OAuth server page -> callback exchanges token -> fill details -> create MCP

### Pattern 2: Dynamic Client Registration
Discover endpoints via API -> dynamic register via API -> create config with DCR credentials -> same authorize flow as pre-registered

### Pattern 3: 3rd-party Access Request
Session user creates OAuth MCP -> external app configures OAuth form with `mcp_servers` scope -> submit access request -> approve with MCP mapping -> token exchange -> REST API tool execution

## Cross-References

- Frontend pages being tested: [05-frontend.md](./05-frontend.md)
- API endpoints being called: [04-routes-app.md](./04-routes-app.md)
